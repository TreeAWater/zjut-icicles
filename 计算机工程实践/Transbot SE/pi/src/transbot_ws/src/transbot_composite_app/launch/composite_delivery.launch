<?xml version="1.0"?>
<launch>
    <!-- TransBot综合应用启动文件 -->
    
    <!-- 参数配置 -->
    <param name="robot_name" value="transbot" />
    <param name="use_sim_time" value="false" />
    
    <!-- 摄像头相关参数 -->
    <arg name="camera_device" default="0" />
    <arg name="camera_width" default="640" />
    <arg name="camera_height" default="480" />
    <arg name="camera_fps" default="5" />
    
    <!-- GUI应用参数 -->
    <arg name="gui_enabled" default="true" />
    <arg name="gui_debug" default="false" />
    
    <!-- 机械臂相关参数 -->
    <arg name="arm_group_name" default="arm" />
    <arg name="use_moveit" default="true" />
    
    <!-- 底盘控制参数 -->
    <arg name="max_linear_vel" default="1.0" />
    <arg name="max_angular_vel" default="2.0" />
    
    <!-- 1. 底盘驱动（如果需要） -->
    <!-- 这里可以启动底盘相关的驱动节点 -->
    <include file="$(find transbot_bringup)/launch/bringup.launch" />
    
    <!-- 2. 摄像头节点 -->
    <node name="usb_cam" pkg="usb_cam" type="usb_cam_node" output="screen">
        <param name="video_device" value="/dev/video$(arg camera_device)" />
        <param name="image_width" value="$(arg camera_width)" />
        <param name="image_height" value="$(arg camera_height)" />
        <param name="pixel_format" value="yuyv" />
        <param name="camera_frame_id" value="usb_cam" />
        <param name="io_method" value="mmap"/>
        <param name="framerate" value="$(arg camera_fps)" />
        <remap from="/usb_cam/image_raw" to="/camera/image_raw" />
    </node>
    
    <!-- 3. 主控制器节点 -->
    <node name="composite_main_controller" pkg="transbot_composite_app" 
          type="main.py" output="screen" respawn="true">
        <param name="max_linear_vel" value="$(arg max_linear_vel)" />
        <param name="max_angular_vel" value="$(arg max_angular_vel)" />
        <rosparam file="$(find transbot_composite_app)/config/robot_params.yaml" command="load" />
    </node>
    
    <!-- 4. 导航控制器 -->
    <node name="navigation_controller" pkg="transbot_composite_app" 
          type="navigation.py" output="screen" respawn="true">
        <param name="planning_frame" value="map" />
        <param name="base_frame" value="base_link" />
    </node>
    
    <!-- 5. 循迹控制器 -->
    <node name="linefollow_controller" pkg="transbot_composite_app" 
          type="linefollow_controller.py" output="screen" respawn="true">
        <param name="camera_topic" value="/camera/image_raw" />
        <param name="debug_image" value="true" />
        <rosparam file="$(find transbot_composite_app)/config/linefollow_params.yaml" command="load" ns="linefollow_controller" />
    </node>
    
    <!-- 6. 机械臂控制器 (如果启用MoveIt!) -->
    <group if="$(arg use_moveit)">
        <!-- 启动MoveIt!规划场景 -->
        <!-- <include file="$(find transbot_se_moveit_config)/launch/planning_context.launch" /> -->
        
        <!-- 机械臂控制节点 -->
        <node name="arm_controller" pkg="transbot_composite_app" 
              type="arm_controller.py" output="screen" respawn="true">
            <param name="arm_group_name" value="$(arg arm_group_name)" />
            <param name="planning_time" value="10.0" />
            <param name="planning_attempts" value="5" />
            <rosparam file="$(find transbot_composite_app)/config/arm_params.yaml" command="load" />
        </node>
    </group>
    
    <!-- 7. GUI控制面板 -->
    <group if="$(arg gui_enabled)">
        <node name="gui_controller" pkg="transbot_composite_app" 
              type="gui_server.py" output="screen" respawn="false">
            <param name="debug_mode" value="$(arg gui_debug)" />
            <param name="video_fps" value="10" />
            <param name="window_title" value="TransBot Control Panel" />
    </node>
    </group>
    
    <!-- 8. 图像传输（可选） -->
    <node name="image_republish" pkg="image_transport" type="republish" 
          args="raw in:=/camera/image_raw compressed out:=/camera/image_compressed" />
    
    <!-- 9. 静态变换发布（根据实际机器人配置） -->
    <node pkg="tf2_ros" type="static_transform_publisher" name="base_to_camera"
          args="0.1 0 0.3 0 0 0 base_link camera_link" />
    
    <!-- 10. RQT图形界面（调试用） -->
    <node name="rqt_gui" pkg="rqt_gui" type="rqt_gui" output="screen" 
          args="--perspective-file $(find transbot_composite_app)/config/transbot.perspective" 
          if="false" />
    
    <!-- 启动信息 -->
    <node name="startup_message" pkg="transbot_composite_app" type="startup_message.py" output="screen" />
    
</launch> 