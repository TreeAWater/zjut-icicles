# 智能外卖配送机器人开发步骤文档

## 项目概述

### 功能描述
开发一套基于 Web 管理的智能外卖配送机器人系统，实现从订单识别到自动配送的完整流程。

### 核心功能
1. **Web 端管理系统**：管理员远程控制和监控
2. **人脸识别认证**：订单确认和取餐验证（基于API调用）
3. **视觉导航系统**：标志识别和路径规划
4. **二维码识别**：目的地解析
5. **自主配送**：路径跟踪和避障

---

## 系统架构设计

### 1. 硬件模块
- **移动底盘**：差速驱动，支持前进/后退/转向
- **摄像头**：视觉识别（人脸、标志、二维码）
- **机械臂**：外卖放置和取回（使用 MoveIt! 控制）
- **传感器**：IMU、编码器、激光雷达（可选）

### 2. 软件模块
```
transbot_composite_app/
├── scripts/
│   ├── main.py                 # 主程序入口
│   ├── web_server.py           # Web 服务器
│   ├── face_recognition.py     # 人脸识别模块（API调用）
│   ├── qr_detection.py         # 二维码识别模块
│   ├── sign_detection.py       # 标志识别模块
│   ├── navigation.py           # 导航控制模块
│   ├── mission_manager.py      # 任务管理器
│   ├── linefollow_controller.py # 循迹控制器（集成transbot_linefollow）
│   ├── arm_controller.py       # 机械臂控制器（集成transbot_se_moveit_config）
│   └── utils/
│       ├── vision_utils.py     # 视觉工具
│       ├── motion_utils.py     # 运动控制工具
│       ├── web_utils.py        # Web 工具
│       └── api_utils.py        # API 调用工具
├── launch/
│   ├── composite_delivery.launch  # 完整系统启动
│   └── web_only.launch           # 仅 Web 端启动
├── config/
│   ├── delivery_config.yaml     # 配送参数配置
│   ├── vision_config.yaml       # 视觉识别参数
│   ├── web_config.yaml          # Web 服务配置
│   └── api_config.yaml          # API 配置参数
└── templates/                   # Web 页面模板
    ├── index.html
    ├── admin.html
    └── static/
```

### 3. 通信架构
```
Web 端 ←→ ROS 节点 ←→ 硬件控制
  ↓         ↓          ↓
WebSocket  Topics   Serial/I2C
  ↓
人脸识别API（第三方服务）
```

### 4. 现有包集成
- **transbot_linefollow**：道路循迹和路径跟踪
- **transbot_se_moveit_config**：机械臂运动规划和控制
- **transbot_bringup**：基础系统启动
- **transbot_msgs**：消息接口

---

## 详细流程分析

### 阶段 1：系统初始化
1. **Web 服务启动**
   - 启动 Flask/Django Web 服务
   - 建立 WebSocket 连接
   - 初始化摄像头服务
   - 配置人脸识别API连接

2. **机器人系统启动**
   - 启动底层驱动（transbot_bringup）
   - 初始化传感器
   - 加载视觉识别模型
   - 启动 MoveIt! 规划器
   - 初始化循迹模块

### 阶段 2：订单接收
1. **管理员登录** → Web 端调用人脸识别API验证
2. **启动主程序** → 发送启动指令到机器人
3. **系统状态同步** → 实时状态反馈到 Web 端

### 阶段 3：外卖识别与路径规划
1. **出发** → 从指定地点开始移动
2. **直行导航** → 使用transbot_linefollow沿直线路径前进
3. **外卖标识别** → 检测"外卖标"并停车
4. **左转操作** → 精确转向 90°
5. **外卖检测** → 识别外卖物品
6. **二维码扫描** → 解析目的地信息（a/b/c）

### 阶段 4：路径选择与导航
1. **路径计算** → 根据目的地选择路线
2. **进入配送道路** → 移动固定角度进入主干道
3. **右转标志识别** → 识别三个右转标志位置
4. **路径决策**：
   - 目的地 a → 第一个右转标志右转
   - 目的地 b → 第二个右转标志右转  
   - 目的地 c → 第三个右转标志右转
5. **沿道路行驶** → 使用transbot_linefollow跟踪路径到目的地

### 阶段 5：配送完成
1. **Stop 标志识别** → 检测到达目的地
2. **用户身份验证** → Web 端调用人脸识别API确认
3. **外卖投递** → 使用transbot_se_moveit_config控制机械臂放置外卖
4. **返程启动** → 右转进入返回道路
5. **返回导航** → 使用transbot_linefollow沿返回路径回到出发点
6. **任务完成** → 结束主程序

---

## 技术实现方案

### 1. 视觉识别技术
- **人脸识别**：第三方API调用（如百度AI、腾讯云、阿里云等）
- **标志识别**：YOLO 或自定义分类器
- **二维码识别**：pyzbar 或 OpenCV
- **路径跟踪**：集成 transbot_linefollow 包

### 2. 导航与控制
- **里程计**：轮式编码器 + IMU 融合
- **路径规划**：基于标志点的状态机
- **运动控制**：PID 控制器
- **转向控制**：基于 IMU 的角度反馈
- **循迹控制**：transbot_linefollow 包提供的循迹算法
- **机械臂控制**：transbot_se_moveit_config 提供的 MoveIt! 规划

### 3. Web 端技术
- **后端**：Flask + SocketIO
- **前端**：HTML5 + JavaScript + WebRTC
- **实时通信**：WebSocket
- **视频流**：MJPEG 或 WebRTC

### 4. API 集成
- **人脸识别API**：支持多种第三方服务
  - 百度AI开放平台
  - 腾讯云人脸识别
  - 阿里云视觉智能
  - Face++
- **API管理**：统一接口，支持服务切换和备用方案

---

## 开发计划

### 第一阶段：基础框架（1-2 周）
1. **项目初始化**
   - 创建包结构
   - 配置开发环境
   - 建立基础通信框架

2. **Web 端开发**
   - 基础 Web 界面
   - WebSocket 通信
   - 摄像头视频流

3. **基础控制**
   - 底盘运动控制
   - 集成 transbot_linefollow
   - 集成 transbot_se_moveit_config

### 第二阶段：视觉识别（2-3 周）
1. **人脸识别模块**
   - API接口封装
   - Web 端集成
   - 多服务备选方案

2. **标志识别模块**
   - 外卖标识别
   - 右转标志识别
   - Stop 标志识别

3. **二维码识别**
   - QR 码检测
   - 内容解析
   - 目的地映射

### 第三阶段：导航系统（2-3 周）
1. **路径规划**
   - 状态机设计
   - 路径计算算法
   - 避障策略

2. **运动控制**
   - PID 调优
   - 转向控制
   - 速度控制
   - transbot_linefollow 参数调优

3. **任务管理**
   - 任务状态机
   - 错误处理
   - 状态同步

### 第四阶段：系统集成（1-2 周）
1. **完整流程测试**
2. **性能优化**
3. **错误处理完善**
4. **用户界面优化**

### 第五阶段：测试与部署（1 周）
1. **功能测试**
2. **压力测试**
3. **部署文档**
4. **用户手册**

---

## 开发优先级

### 高优先级
1. 基础运动控制
2. Web 端通信
3. 人脸识别API集成
4. 标志识别
5. transbot_linefollow 集成
6. transbot_se_moveit_config 集成

### 中优先级
1. 二维码识别
2. 路径规划
3. 状态管理
4. 错误处理

### 低优先级
1. 界面美化
2. 性能优化
3. 高级功能
4. 扩展接口

---

## 依赖包管理

### 现有 transbot 包
- **transbot_linefollow**：循迹功能
  - 依赖：OpenCV、geometry_msgs
  - 功能：线条检测、路径跟踪
  
- **transbot_se_moveit_config**：机械臂控制
  - 依赖：MoveIt!、moveit_ros_planning
  - 功能：运动规划、轨迹执行

- **transbot_bringup**：系统启动
  - 依赖：基础驱动、传感器
  - 功能：硬件初始化

### 新增依赖
- **Flask-SocketIO**：Web实时通信
- **requests**：API调用
- **pyzbar**：二维码识别
- **opencv-python**：图像处理
- **numpy**：数值计算

---

## API 配置方案

### 人脸识别API配置示例
```yaml
# config/api_config.yaml
face_recognition:
  primary_service: "baidu"  # 主要服务
  backup_services: ["tencent", "aliyun"]  # 备用服务
  
  baidu:
    app_id: "your_app_id"
    api_key: "your_api_key"
    secret_key: "your_secret_key"
    endpoint: "https://aip.baidubce.com/rest/2.0/face/v3"
    
  tencent:
    secret_id: "your_secret_id"
    secret_key: "your_secret_key"
    region: "ap-beijing"
    
  aliyun:
    access_key_id: "your_access_key_id"
    access_key_secret: "your_access_key_secret"
    endpoint: "your_endpoint"

timeout: 5.0  # API超时时间
retry_times: 3  # 重试次数
```

---

## 风险评估与对策

### 技术风险
1. **API服务稳定性** → 多服务备选，本地缓存
2. **网络通信稳定性** → 断线重连，状态缓存
3. **导航精度** → 多传感器融合，标志点校正
4. **现有包兼容性** → 版本锁定，接口适配

### 时间风险
1. **开发周期过长** → 模块化开发，并行推进
2. **调试时间不足** → 早期测试，持续集成
3. **API集成复杂** → 提前验证，接口封装

### 设备风险
1. **硬件故障** → 备用设备，模块化设计
2. **环境依赖** → 多场景测试，参数可配
3. **API费用控制** → 用量监控，成本预算

---

## 成功标准

### 功能指标
- [ ] Web 端人脸识别准确率 > 95%（API依赖）
- [ ] 标志识别准确率 > 90%
- [ ] 路径跟踪精度 < 10cm 偏差
- [ ] 完整配送成功率 > 85%
- [ ] transbot_linefollow 集成成功率 > 95%
- [ ] transbot_se_moveit_config 集成成功率 > 95%

### 性能指标
- [ ] 系统响应时间 < 2s
- [ ] 视频流延迟 < 500ms
- [ ] 单次配送时间 < 10min
- [ ] 系统稳定运行 > 2h
- [ ] API调用响应时间 < 3s

### 可用性指标
- [ ] Web 界面易用性良好
- [ ] 错误恢复能力强
- [ ] 状态反馈及时准确
- [ ] 文档完整清晰
- [ ] API服务可用率 > 99%

---

**开发负责人**：[待定]  
**项目周期**：预计 8-10 周  
**最后更新**：[当前日期] 