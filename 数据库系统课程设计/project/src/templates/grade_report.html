{% extends "base.html" %}

{% block title %}成绩单 - 教务管理系统{% endblock %}

{% block head_extra %}
<style>
    .grade-container {
        max-width: 1000px;
        margin: 20px auto;
        padding: 20px;
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
    }
    
    .grade-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
    }
    
    .grade-title {
        font-size: 1.5em;
        font-weight: 500;
    }
    
    .grade-summary {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 8px;
    }
    
    .summary-item {
        text-align: center;
    }
    
    .summary-label {
        font-size: 0.9em;
        color: #666;
    }
    
    .summary-value {
        font-size: 1.2em;
        font-weight: 500;
        color: #0056b3;
    }
    
    .grade-filters {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
    }
    
    .grade-filters select {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    
    .grade-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .grade-table th, .grade-table td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #ddd;
    }
    
    .grade-table th {
        background-color: #f8f9fa;
        font-weight: 500;
    }
    
    .grade-table tr:hover {
        background-color: #f5f5f5;
    }
    
    .grade-passed {
        color: #28a745;
    }
    
    .grade-failed {
        color: #dc3545;
    }
    
    .grade-pending {
        color: #ffc107;
    }
    
    .export-button {
        padding: 8px 15px;
        background-color: #0056b3;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    
    .export-button:hover {
        background-color: #004494;
    }
    
    .no-data {
        text-align: center;
        padding: 30px;
        color: #666;
    }
</style>
{% endblock %}

{% block content %}
<div class="grade-container">
    <div class="grade-header">
        <div class="grade-title">学生成绩单</div>
        <button class="export-button" onclick="exportGrades()">导出成绩单</button>
    </div>
    
    <div class="grade-summary">
        <div class="summary-item">
            <div class="summary-label">总学分</div>
            <div class="summary-value" id="total-credits">0.0</div>
        </div>
        <div class="summary-item">
            <div class="summary-label">平均绩点</div>
            <div class="summary-value" id="gpa">0.00</div>
        </div>
        <div class="summary-item">
            <div class="summary-label">已修课程数</div>
            <div class="summary-value" id="course-count">0</div>
        </div>
        <div class="summary-item">
            <div class="summary-label">通过率</div>
            <div class="summary-value" id="pass-rate">0%</div>
        </div>
    </div>
    
    <div class="grade-filters">
        <select id="semester-filter" onchange="filterGrades()">
            <option value="all">全部学期</option>
            <option value="2024-Fall">2024秋季学期</option>
            <option value="2024-Spring">2024春季学期</option>
            <option value="2023-Fall">2023秋季学期</option>
        </select>
        
        <select id="course-type-filter" onchange="filterGrades()">
            <option value="all">全部课程类型</option>
            <option value="必修">必修课</option>
            <option value="专业选修">专业选修课</option>
            <option value="通识选修">通识选修课</option>
        </select>
    </div>
    
    <table class="grade-table">
        <thead>
            <tr>
                <th>学期</th>
                <th>课程代码</th>
                <th>课程名称</th>
                <th>学分</th>
                <th>课程类型</th>
                <th>成绩</th>
                <th>绩点</th>
                <th>状态</th>
            </tr>
        </thead>
        <tbody id="grades-body">
            <!-- 成绩数据将通过JavaScript动态加载 -->
        </tbody>
    </table>
    
    <div id="no-data" class="no-data" style="display: none;">
        暂无成绩数据
    </div>
</div>

{% endblock %}

{% block scripts_extra %}
<script>
    // 页面加载完成后获取成绩数据
    document.addEventListener('DOMContentLoaded', function() {
        fetchGrades();
    });
    
    // 从服务器获取成绩数据
    function fetchGrades() {
        // 获取筛选条件
        const semesterFilter = document.getElementById('semester-filter').value;
        const courseTypeFilter = document.getElementById('course-type-filter').value;
        
        // 构建请求URL
        let url = '/api/student/grades';
        const params = [];
        
        if (semesterFilter !== 'all') {
            params.push(`semester=${semesterFilter}`);
        }
        
        if (courseTypeFilter !== 'all') {
            params.push(`course_type=${courseTypeFilter}`);
        }
        
        if (params.length > 0) {
            url += '?' + params.join('&');
        }
        
        // 发送AJAX请求
        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error('网络响应不正常');
                }
                return response.json();
            })
            .then(data => {
                displayGrades(data.grades);
                updateSummary(data.summary);
            })
            .catch(error => {
                console.error('获取成绩数据失败:', error);
                document.getElementById('no-data').style.display = 'block';
                document.getElementById('no-data').textContent = '获取成绩数据失败，请稍后再试';
            });
    }
    
    // 显示成绩数据
    function displayGrades(grades) {
        const tbody = document.getElementById('grades-body');
        const noData = document.getElementById('no-data');
        
        tbody.innerHTML = '';
        
        if (!grades || grades.length === 0) {
            noData.style.display = 'block';
            return;
        }
        
        noData.style.display = 'none';
        
        grades.forEach(grade => {
            const row = document.createElement('tr');
            
            // 根据是否及格设置状态
            const status = grade.is_passing ? 'passed' : 'failed';
            
            row.innerHTML = `
                <td>${formatSemester(grade.semester_id)}</td>
                <td>${grade.course_id}</td>
                <td>${grade.course_title}</td>
                <td>${grade.credits}</td>
                <td>${grade.course_type}</td>
                <td>${grade.numeric_grade !== null ? grade.numeric_grade : '-'}</td>
                <td>${grade.grade_point !== null ? grade.grade_point : '-'}</td>
                <td class="grade-${status}">${grade.is_passing ? '通过' : '不通过'}</td>
            `;
            
            tbody.appendChild(row);
        });
    }
    
    // 更新成绩汇总信息
    function updateSummary(summary) {
        if (!summary) return;
        
        document.getElementById('total-credits').textContent = summary.total_credits.toFixed(1);
        document.getElementById('gpa').textContent = summary.gpa.toFixed(2);
        document.getElementById('course-count').textContent = summary.course_count;
        document.getElementById('pass-rate').textContent = summary.pass_rate.toFixed(0) + '%';
    }
    
    // 根据筛选条件过滤成绩
    function filterGrades() {
        fetchGrades();
    }
    
    // 导出成绩单
    function exportGrades() {
        alert('成绩单导出功能将在后续版本中实现');
    }
    
    // 格式化学期显示
    function formatSemester(semester) {
        if (!semester) return '';
        
        const [year, term] = semester.split('-');
        const termMap = {
            'Spring': '春季学期',
            'Fall': '秋季学期',
            'Summer': '夏季学期'
        };
        return `${year}年${termMap[term] || term}`;
    }
</script>
{% endblock %} 