{% extends "base.html" %}

{% block title %}班级名单 - 教务管理系统{% endblock %}

{% block head_extra %}
<style>
    .roster-container {
        max-width: 1000px;
        margin: 20px auto;
        padding: 20px;
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
    }
    
    .roster-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
    }
    
    .roster-title {
        font-size: 1.5em;
        font-weight: 500;
    }
    
    .roster-actions {
        display: flex;
        gap: 10px;
    }
    
    .roster-actions button {
        padding: 8px 15px;
        background-color: #0056b3;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    
    .roster-actions button:hover {
        background-color: #004494;
    }
    
    .course-selector {
        margin-bottom: 20px;
        display: flex;
        gap: 10px;
        align-items: center;
    }
    
    .course-selector select {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        flex-grow: 1;
    }
    
    .refresh-btn {
        padding: 8px 15px;
        background-color: #28a745;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .refresh-btn:hover {
        background-color: #218838;
    }
    
    .course-info {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    
    .course-info h3 {
        margin-top: 0;
        margin-bottom: 10px;
        font-size: 1.2em;
    }
    
    .course-info p {
        margin: 5px 0;
    }
    
    .course-info strong {
        font-weight: 500;
    }
    
    .roster-filters {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    
    .roster-filters input {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        flex-grow: 1;
    }
    
    .roster-filters button {
        padding: 8px 15px;
        background-color: #0056b3;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    
    .roster-filters button:hover {
        background-color: #004494;
    }
    
    .roster-summary {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
        font-size: 0.9em;
    }
    
    .roster-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
    }
    
    .roster-table th, .roster-table td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #ddd;
    }
    
    .roster-table th {
        background-color: #f8f9fa;
        font-weight: 500;
    }
    
    .roster-table tr:hover {
        background-color: #f5f5f5;
    }
    
    .student-status {
        padding: 3px 8px;
        border-radius: 10px;
        font-size: 0.85em;
        font-weight: 500;
    }
    
    .status-normal {
        background-color: #d4edda;
        color: #155724;
    }
    
    .status-warning {
        background-color: #fff3cd;
        color: #856404;
    }
    
    .status-danger {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    .pagination {
        display: flex;
        justify-content: center;
        margin-top: 20px;
    }
    
    .pagination button {
        padding: 5px 10px;
        margin: 0 5px;
        border: 1px solid #ddd;
        background-color: #fff;
        cursor: pointer;
        border-radius: 4px;
    }
    
    .pagination button:hover {
        background-color: #f5f5f5;
    }
    
    .pagination button.active {
        background-color: #0056b3;
        color: white;
        border-color: #0056b3;
    }
    
    .pagination button:disabled {
        color: #ccc;
        cursor: not-allowed;
    }
    
    .no-students {
        text-align: center;
        padding: 30px;
        color: #666;
        background-color: #f8f9fa;
        border-radius: 4px;
    }
    
    .loading-spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255,255,255,.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    /* 成绩输入框样式 */
    .grade-input {
        width: 60px;
        padding: 5px;
        border: 1px solid #ddd;
        border-radius: 4px;
        text-align: center;
    }
    
    .grade-input:focus {
        border-color: #0056b3;
        outline: none;
        box-shadow: 0 0 0 2px rgba(0,86,179,0.25);
    }
    
    .grade-input.modified {
        background-color: #fff3cd;
    }
    
    .grade-input.error {
        border-color: #dc3545;
        background-color: #f8d7da;
    }
    
    /* 成绩保存按钮样式 */
    .save-grade-btn {
        padding: 2px 8px;
        background-color: #28a745;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.85em;
    }
    
    .save-grade-btn:hover {
        background-color: #218838;
    }
    
    /* 成绩保存成功提示 */
    .grade-saved {
        color: #28a745;
        font-size: 0.85em;
        margin-left: 5px;
        display: inline-block;
        animation: fadeOut 2s forwards;
        animation-delay: 3s;
    }
    
    @keyframes fadeOut {
        from { opacity: 1; }
        to { opacity: 0; }
    }
</style>
{% endblock %}

{% block content %}
<div class="roster-container">
    <div class="roster-header">
        <div class="roster-title">班级名单</div>
        <div class="roster-actions">
            <button onclick="saveAllGrades()" style="background-color: #28a745;">批量保存成绩</button>
            <button onclick="exportRoster()">导出名单</button>
            <button onclick="printRoster()">打印名单</button>
            <button onclick="checkDatabase()" style="background-color: #dc3545;">检查数据库</button>
            <button onclick="initTestData()" style="background-color: #28a745;">初始化测试数据</button>
            <button onclick="checkDatabaseInfo()" style="background-color: #17a2b8;">数据库信息</button>
        </div>
    </div>
    
    <div class="course-selector">
        <select id="course-select" onchange="changeCourse()">
            <!-- 课程选项将通过JavaScript动态加载 -->
            <option value="">加载中...</option>
        </select>
        <button class="refresh-btn" id="refresh-btn" onclick="refreshRoster()">
            <span id="refresh-icon">刷新</span>
            <span id="loading-spinner" class="loading-spinner" style="display: none;"></span>
        </button>
    </div>
    
    <div class="course-info">
        <!-- 课程信息将通过JavaScript动态加载 -->
        <h3>加载中...</h3>
        <p><strong>学期：</strong>--</p>
        <p><strong>教学班：</strong>--</p>
        <p><strong>学分：</strong>--</p>
        <p><strong>课程类型：</strong>--</p>
        <p><strong>上课时间：</strong>--</p>
        <p><strong>上课地点：</strong>--</p>
        <p><strong>选课人数：</strong>--</p>
    </div>
    
    <div class="roster-filters">
        <input type="text" id="search-input" placeholder="搜索学号、姓名或专业">
        <button onclick="searchStudents()">搜索</button>
    </div>
    
    <div class="roster-summary">
        <div>总人数：<strong>--</strong> 人</div>
        <div>男生：<strong>--</strong> 人 | 女生：<strong>--</strong> 人</div>
    </div>
    
    <table class="roster-table">
        <thead>
            <tr>
                <th>序号</th>
                <th>学号</th>
                <th>姓名</th>
                <th>性别</th>
                <th>专业</th>
                <th>年级</th>
                <th>成绩</th>
                <th>等级</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody id="roster-body">
            <!-- 学生名单将通过JavaScript动态加载 -->
        </tbody>
    </table>
    
    <div id="no-students" class="no-students" style="display: none;">
        没有找到符合条件的学生
    </div>
    
    <div class="pagination" id="pagination">
        <!-- 分页按钮将通过JavaScript动态生成 -->
    </div>
    
    <!-- 调试信息区域 -->
    <div id="debug-info" style="margin-top: 30px; padding: 15px; background-color: #f8f9fa; border-radius: 8px; display: none;">
        <h3>调试信息</h3>
        <pre id="debug-content" style="white-space: pre-wrap; overflow-x: auto;"></pre>
    </div>
</div>

{% endblock %}

{% block scripts_extra %}
<script>
    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
        loadCourses();
    });
    
    // 加载教师授课的课程列表
    function loadCourses() {
        console.log('开始加载课程列表...');
        fetch('/api/instructor/teaching_sections')
            .then(response => {
                console.log('API响应状态:', response.status);
                if (!response.ok) {
                    throw new Error('网络响应不正常，状态码: ' + response.status);
                }
                return response.text().then(text => {
                    console.log('原始响应内容:', text);
                    try {
                        return JSON.parse(text);
                    } catch (e) {
                        console.error('JSON解析错误:', e);
                        throw new Error('无法解析响应数据');
                    }
                });
            })
            .then(data => {
                console.log('解析后的数据:', data);
                if (data.error) {
                    console.error('获取课程列表失败:', data.error);
                    document.getElementById('no-students').style.display = 'block';
                    document.getElementById('no-students').textContent = '获取课程列表失败: ' + data.error;
                    return;
                }
                
                const courseSelect = document.getElementById('course-select');
                courseSelect.innerHTML = '';
                
                if (data.length === 0) {
                    console.log('没有找到课程数据');
                    courseSelect.innerHTML = '<option value="">暂无教学班</option>';
                    document.getElementById('no-students').style.display = 'block';
                    document.getElementById('no-students').textContent = '您当前没有教授任何课程';
                    return;
                }
                
                data.forEach(course => {
                    const option = document.createElement('option');
                    option.value = course.lyh_section_id;
                    option.textContent = `${course.lyh_course_title} (${course.lyh_course_id}) - ${course.lyh_class_name} (${course.lyh_semester_name})`;
                    courseSelect.appendChild(option);
                });
                
                // 加载第一个课程的班级名单
                if (data[0]) {
                    loadRoster(data[0].lyh_section_id);
                }
            })
            .catch(error => {
                console.error('获取课程列表失败:', error);
                document.getElementById('no-students').style.display = 'block';
                document.getElementById('no-students').textContent = '获取课程列表失败，请稍后再试: ' + error.message;
            });
    }
    
    // 加载班级名单
    function loadRoster(sectionIdParam) {
        console.log('开始加载班级名单...');
        // 显示加载状态
        showLoading(true);
        
        // 获取当前选择的教学班
        const courseSelect = document.getElementById('course-select');
        const sectionId = sectionIdParam || (courseSelect.value || '');
        
        console.log('选中的教学班ID:', sectionId);
        
        if (!sectionId) {
            console.error('未选择教学班');
            document.getElementById('no-students').style.display = 'block';
            document.getElementById('no-students').textContent = '请选择一个教学班';
            showLoading(false);
            return;
        }
        
        const searchInput = document.getElementById('search-input').value;
        
        // 构建请求URL
        let url = '/api/instructor/class_roster';
        const params = [];
        
        params.push(`section_id=${sectionId}`);
        
        if (searchInput) {
            params.push(`search=${encodeURIComponent(searchInput)}`);
        }
        
        if (params.length > 0) {
            url += '?' + params.join('&');
        }
        
        console.log('请求URL:', url);
        
        // 发送AJAX请求
        fetch(url)
            .then(response => {
                console.log('API响应状态:', response.status);
                if (!response.ok) {
                    throw new Error('网络响应不正常，状态码: ' + response.status);
                }
                return response.text().then(text => {
                    console.log('原始响应内容:', text);
                    try {
                        return JSON.parse(text);
                    } catch (e) {
                        console.error('JSON解析错误:', e);
                        throw new Error('无法解析响应数据');
                    }
                });
            })
            .then(data => {
                console.log('解析后的数据:', data);
                // 显示调试信息
                const debugInfo = document.getElementById('debug-info');
                const debugContent = document.getElementById('debug-content');
                debugInfo.style.display = 'block';
                debugContent.textContent = JSON.stringify(data, null, 2);
                
                if (data.error) {
                    console.error('获取班级名单失败:', data.error);
                    document.getElementById('no-students').style.display = 'block';
                    document.getElementById('no-students').textContent = data.error;
                    showLoading(false);
                    return;
                }
                
                // 检查返回的数据结构
                console.log('课程信息:', data.course_info);
                console.log('学生列表:', data.students);
                console.log('摘要信息:', data.summary);
                
                if (!data.course_info) {
                    console.error('返回的数据中缺少课程信息');
                    document.getElementById('no-students').style.display = 'block';
                    document.getElementById('no-students').textContent = '返回的数据中缺少课程信息';
                    showLoading(false);
                    return;
                }
                
                if (!data.students) {
                    console.error('返回的数据中缺少学生列表');
                    document.getElementById('no-students').style.display = 'block';
                    document.getElementById('no-students').textContent = '返回的数据中缺少学生列表';
                    showLoading(false);
                    return;
                }
                
                displayRoster(data.students);
                updateCourseInfo(data.course_info);
                updateRosterSummary(data.summary);
                showLoading(false);
            })
            .catch(error => {
                console.error('获取班级名单失败:', error);
                document.getElementById('no-students').style.display = 'block';
                document.getElementById('no-students').textContent = '获取班级名单失败，请稍后再试: ' + error.message;
                showLoading(false);
            });
    }
    
    // 显示加载状态
    function showLoading(isLoading) {
        const refreshIcon = document.getElementById('refresh-icon');
        const loadingSpinner = document.getElementById('loading-spinner');
        const refreshBtn = document.getElementById('refresh-btn');
        
        if (isLoading) {
            refreshIcon.style.display = 'none';
            loadingSpinner.style.display = 'inline-block';
            refreshBtn.disabled = true;
        } else {
            refreshIcon.style.display = 'inline-block';
            loadingSpinner.style.display = 'none';
            refreshBtn.disabled = false;
        }
    }
    
    // 刷新班级名单
    function refreshRoster() {
        loadRoster();
    }
    
    // 显示班级名单
    function displayRoster(students) {
        const tbody = document.getElementById('roster-body');
        const noStudents = document.getElementById('no-students');
        
        tbody.innerHTML = '';
        
        if (!students || students.length === 0) {
            noStudents.style.display = 'block';
            noStudents.textContent = '该教学班暂无学生';
            return;
        }
        
        noStudents.style.display = 'none';
        
        students.forEach((student, index) => {
            if (!student || !student.student_id) {
                console.warn('跳过无效的学生数据:', student);
                return;
            }
            
            const row = document.createElement('tr');
            
            // 获取当前教学班ID
            const sectionId = document.getElementById('course-select').value;
            
            row.innerHTML = `
                <td>${index + 1}</td>
                <td>${student.student_id || '--'}</td>
                <td>${student.student_name || '--'}</td>
                <td>${student.gender || '--'}</td>
                <td>${student.major_name || '--'}</td>
                <td>${student.grade ? student.grade + '级' : '--'}</td>
                <td>
                    <input type="number" class="grade-input" 
                           value="${student.numeric_grade || ''}" 
                           min="0" max="100" step="0.1"
                           data-student-id="${student.student_id}"
                           data-section-id="${sectionId}"
                           data-original-value="${student.numeric_grade || ''}"
                           onchange="gradeChanged(this)">
                </td>
                <td>${student.letter_grade || '--'}</td>
                <td>
                    <a href="#" onclick="viewStudentDetail('${student.student_id}')">查看</a> | 
                    <a href="#" onclick="saveGrade('${student.student_id}', '${sectionId}')">保存成绩</a>
                </td>
            `;
            
            tbody.appendChild(row);
        });
    }
    
    // 更新课程信息
    function updateCourseInfo(courseInfo) {
        if (!courseInfo) {
            console.error('课程信息为空');
            return;
        }
        
        console.log('更新课程信息:', courseInfo);
        
        const courseInfoContainer = document.querySelector('.course-info');
        courseInfoContainer.innerHTML = `
            <h3>${courseInfo.lyh_course_id || '--'} - ${courseInfo.lyh_course_title || '--'}</h3>
            <p><strong>学期：</strong>${courseInfo.lyh_semester_name || '--'}</p>
            <p><strong>教学班：</strong>${courseInfo.lyh_class_name || '--'}</p>
            <p><strong>学分：</strong>${courseInfo.lyh_credits || '--'}</p>
            <p><strong>课程类型：</strong>${courseInfo.course_type || '--'}</p>
            <p><strong>上课时间：</strong>${courseInfo.time_slot_desc || '待定'}</p>
            <p><strong>上课地点：</strong>${courseInfo.classroom_location || '待定'}</p>
            <p><strong>选课人数：</strong>${courseInfo.enrolled_count || 0}人</p>
        `;
    }
    
    // 更新班级名单摘要
    function updateRosterSummary(summary) {
        if (!summary) {
            console.error('摘要信息为空');
            return;
        }
        
        console.log('更新摘要信息:', summary);
        
        const summaryContainer = document.querySelector('.roster-summary');
        summaryContainer.innerHTML = `
            <div>总人数：<strong>${summary.total_count || 0}</strong> 人</div>
            <div>男生：<strong>${summary.male_count || 0}</strong> 人 | 女生：<strong>${summary.female_count || 0}</strong> 人</div>
            <div>平均成绩：<strong>${summary.avg_grade || '暂无'}</strong></div>
        `;
    }
    
    // 切换课程
    function changeCourse() {
        loadRoster();
    }
    
    // 搜索学生
    function searchStudents() {
        loadRoster();
    }
    
    // 导出名单
    function exportRoster() {
        const sectionId = document.getElementById('course-select').value;
        
        // 构建导出URL
        const exportUrl = `/api/instructor/export_roster?section_id=${sectionId}`;
        
        // 创建临时链接并点击
        const link = document.createElement('a');
        link.href = exportUrl;
        link.target = '_blank';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    // 查看学生详情
    function viewStudentDetail(studentId) {
        const sectionId = document.getElementById('course-select').value;
        
        // 构建学生详情URL
        const detailUrl = `/api/instructor/student_detail?student_id=${studentId}&section_id=${sectionId}`;
        
        // 发送AJAX请求获取学生详情
        fetch(detailUrl)
            .then(response => response.json())
            .then(data => {
                // 显示学生详情对话框
                showStudentDetailDialog(data);
            })
            .catch(error => {
                console.error('获取学生详情失败:', error);
                alert('获取学生详情失败，请稍后再试');
            });
    }
    
    // 显示学生详情对话框
    function showStudentDetailDialog(studentData) {
        alert(`学生 ${studentData.student_name} (${studentData.student_id}) 的详细信息将在对话框中显示`);
        // 实际应用中，这里应该显示一个包含学生详细信息的对话框
    }
    
    // 打印名单
    function printRoster() {
        window.print();
    }
    
    // 检查数据库
    function checkDatabase() {
        fetch('/api/debug/check_database')
            .then(response => response.json())
            .then(data => {
                const debugInfo = document.getElementById('debug-info');
                const debugContent = document.getElementById('debug-content');
                debugInfo.style.display = 'block';
                debugContent.textContent = JSON.stringify(data, null, 2);
            })
            .catch(error => {
                console.error('检查数据库失败:', error);
                const debugInfo = document.getElementById('debug-info');
                const debugContent = document.getElementById('debug-content');
                debugInfo.style.display = 'block';
                debugContent.textContent = '检查数据库失败: ' + error.message;
            });
    }
    
    // 初始化测试数据
    function initTestData() {
        fetch('/api/debug/init_test_data')
            .then(response => response.json())
            .then(data => {
                const debugInfo = document.getElementById('debug-info');
                const debugContent = document.getElementById('debug-content');
                debugInfo.style.display = 'block';
                debugContent.textContent = JSON.stringify(data, null, 2);
                
                // 初始化成功后重新加载课程列表
                if (!data.error) {
                    setTimeout(() => {
                        loadCourses();
                    }, 1000);
                }
            })
            .catch(error => {
                console.error('初始化测试数据失败:', error);
                const debugInfo = document.getElementById('debug-info');
                const debugContent = document.getElementById('debug-content');
                debugInfo.style.display = 'block';
                debugContent.textContent = '初始化测试数据失败: ' + error.message;
            });
    }
    
    // 检查数据库信息
    function checkDatabaseInfo() {
        fetch('/api/debug/database_info')
            .then(response => response.json())
            .then(data => {
                const debugInfo = document.getElementById('debug-info');
                const debugContent = document.getElementById('debug-content');
                debugInfo.style.display = 'block';
                debugContent.textContent = JSON.stringify(data, null, 2);
            })
            .catch(error => {
                console.error('获取数据库信息失败:', error);
                const debugInfo = document.getElementById('debug-info');
                const debugContent = document.getElementById('debug-content');
                debugInfo.style.display = 'block';
                debugContent.textContent = '获取数据库信息失败: ' + error.message;
            });
    }
    
    // 成绩输入框值变化时的处理
    function gradeChanged(input) {
        // 获取原始值和当前值
        const originalValue = input.getAttribute('data-original-value');
        const currentValue = input.value;
        
        // 如果值发生变化，添加modified类
        if (originalValue !== currentValue) {
            input.classList.add('modified');
        } else {
            input.classList.remove('modified');
        }
        
        // 验证成绩范围
        const numValue = parseFloat(currentValue);
        if (isNaN(numValue) || numValue < 0 || numValue > 100) {
            input.classList.add('error');
        } else {
            input.classList.remove('error');
        }
    }
    
    // 保存学生成绩
    function saveGrade(studentId, sectionId) {
        // 找到对应的成绩输入框
        const gradeInput = document.querySelector(`.grade-input[data-student-id="${studentId}"][data-section-id="${sectionId}"]`);
        
        if (!gradeInput) {
            console.error('找不到对应的成绩输入框');
            return;
        }
        
        // 获取成绩值
        const numericGrade = gradeInput.value ? parseFloat(gradeInput.value) : null;
        
        // 验证成绩范围
        if (numericGrade !== null && (isNaN(numericGrade) || numericGrade < 0 || numericGrade > 100)) {
            alert('成绩必须在0-100之间');
            gradeInput.classList.add('error');
            return;
        }
        
        // 如果成绩没有变化，不进行保存
        const originalValue = gradeInput.getAttribute('data-original-value');
        if (originalValue === gradeInput.value) {
            alert('成绩未发生变化');
            return;
        }
        
        // 显示保存中状态
        const parentCell = gradeInput.parentElement.nextElementSibling.nextElementSibling;
        parentCell.innerHTML = '<span>保存中...</span>';
        
        // 发送成绩更新请求
        fetch('/api/instructor/update_grade', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                student_id: studentId,
                section_id: sectionId,
                grade: numericGrade
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('网络响应不正常，状态码: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            console.log('成绩更新结果:', data);
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            // 更新成功，更新原始值和显示
            gradeInput.setAttribute('data-original-value', gradeInput.value);
            gradeInput.classList.remove('modified');
            
            // 更新字母等级显示
            const letterGradeCell = gradeInput.parentElement.nextElementSibling;
            letterGradeCell.textContent = data.letter_grade || '--';
            
            // 恢复操作按钮并显示成功提示
            parentCell.innerHTML = `
                <a href="#" onclick="viewStudentDetail('${studentId}')">查看</a> | 
                <a href="#" onclick="saveGrade('${studentId}', '${sectionId}')">保存成绩</a>
                <span class="grade-saved">✓ 已保存</span>
            `;
            
            // 更新平均成绩显示
            refreshRoster();
        })
        .catch(error => {
            console.error('更新成绩失败:', error);
            
            // 恢复操作按钮并显示错误提示
            parentCell.innerHTML = `
                <a href="#" onclick="viewStudentDetail('${studentId}')">查看</a> | 
                <a href="#" onclick="saveGrade('${studentId}', '${sectionId}')">保存成绩</a>
                <span style="color: #dc3545; font-size: 0.85em;">✗ 保存失败</span>
            `;
            
            alert('更新成绩失败: ' + error.message);
        });
    }
    
    // 批量保存所有修改的成绩
    function saveAllGrades() {
        // 获取所有已修改的成绩输入框
        const modifiedInputs = document.querySelectorAll('.grade-input.modified:not(.error)');
        
        if (modifiedInputs.length === 0) {
            alert('没有需要保存的成绩修改');
            return;
        }
        
        // 确认保存
        if (!confirm(`确定要保存 ${modifiedInputs.length} 条成绩修改吗？`)) {
            return;
        }
        
        // 显示保存进度
        let savedCount = 0;
        let errorCount = 0;
        
        // 逐个保存成绩
        modifiedInputs.forEach(input => {
            const studentId = input.getAttribute('data-student-id');
            const sectionId = input.getAttribute('data-section-id');
            const numericGrade = input.value ? parseFloat(input.value) : null;
            
            // 发送成绩更新请求
            fetch('/api/instructor/update_grade', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    student_id: studentId,
                    section_id: sectionId,
                    grade: numericGrade
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    errorCount++;
                    console.error(`学生 ${studentId} 成绩更新失败:`, data.error);
                } else {
                    savedCount++;
                    
                    // 更新成功，更新原始值和显示
                    input.setAttribute('data-original-value', input.value);
                    input.classList.remove('modified');
                    
                    // 更新字母等级显示
                    const letterGradeCell = input.parentElement.nextElementSibling;
                    letterGradeCell.textContent = data.letter_grade || '--';
                }
                
                // 所有请求完成后刷新名单
                if (savedCount + errorCount === modifiedInputs.length) {
                    alert(`成绩保存完成，成功: ${savedCount}，失败: ${errorCount}`);
                    if (savedCount > 0) {
                        refreshRoster();
                    }
                }
            })
            .catch(error => {
                errorCount++;
                console.error(`学生 ${studentId} 成绩更新失败:`, error);
                
                // 所有请求完成后刷新名单
                if (savedCount + errorCount === modifiedInputs.length) {
                    alert(`成绩保存完成，成功: ${savedCount}，失败: ${errorCount}`);
                    if (savedCount > 0) {
                        refreshRoster();
                    }
                }
            });
        });
    }
</script>
{% endblock %} 