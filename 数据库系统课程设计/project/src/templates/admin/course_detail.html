{% extends "base.html" %}

{% block title %}课程详情 - 教务管理系统{% endblock %}

{% block head_extra %}
<style>
    .course-detail-container {
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
    }
    .page-header {
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #4CAF50;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .course-info {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 30px;
    }
    .course-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 15px;
    }
    .course-info-item {
        margin-bottom: 10px;
    }
    .course-info-item label {
        font-weight: bold;
        display: block;
        margin-bottom: 5px;
    }
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #ddd;
    }
    .tab-navigation {
        display: flex;
        border-bottom: 1px solid #ddd;
        margin-bottom: 20px;
    }
    .tab-button {
        padding: 10px 20px;
        cursor: pointer;
        border: none;
        background: none;
        font-weight: bold;
        color: #666;
    }
    .tab-button.active {
        border-bottom: 2px solid #4CAF50;
        color: #4CAF50;
    }
    .tab-content {
        display: none;
    }
    .tab-content.active {
        display: block;
    }
    .btn-primary {
        background-color: #4CAF50;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
    }
    .btn-primary:hover {
        background-color: #45a049;
    }
    .btn-secondary {
        background-color: #2196f3;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }
    .btn-secondary:hover {
        background-color: #1976d2;
    }
    .btn-danger {
        background-color: #f44336;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }
    .btn-danger:hover {
        background-color: #d32f2f;
    }
    .results-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }
    .results-table th {
        background-color: #f5f5f5;
        padding: 10px;
        text-align: left;
        border-bottom: 2px solid #ddd;
    }
    .results-table td {
        padding: 10px;
        border-bottom: 1px solid #eee;
    }
    .results-table tr:hover {
        background-color: #f9f9f9;
    }
    .empty-state {
        text-align: center;
        padding: 40px;
        color: #666;
    }
    .loading {
        text-align: center;
        padding: 40px;
    }
    .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #4CAF50;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .badge {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
    }
    .badge-success {
        background-color: #4CAF50;
        color: white;
    }
    .badge-danger {
        background-color: #f44336;
        color: white;
    }
    .instructor-item {
        background: #f5f5f5;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
        background-color: white;
        margin: 10% auto;
        padding: 20px;
        border-radius: 8px;
        width: 60%;
        max-width: 600px;
    }
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
    }
    .modal-header h3 {
        margin: 0;
    }
    .close-btn {
        font-size: 24px;
        font-weight: bold;
        cursor: pointer;
    }
    .form-group {
        margin-bottom: 15px;
    }
    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
    }
    .form-group input, .form-group select, .form-group textarea {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    .form-group textarea {
        height: 100px;
    }
    .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="course-detail-container">
    <div class="page-header">
        <h1>课程详情</h1>
        <div>
            <a href="/course_search" class="btn-secondary">返回课程列表</a>
        </div>
    </div>
    
    <div id="loadingIndicator" class="loading">
        <div class="loading-spinner"></div>
        <p>加载数据中...</p>
    </div>
    
    <div id="courseContent" style="display: none;">
        <div class="course-info">
            <h2 id="courseTitle">课程名称</h2>
            <div class="course-info-grid">
                <div class="course-info-item">
                    <label>课程ID</label>
                    <div id="courseId"></div>
                </div>
                <div class="course-info-item">
                    <label>学分</label>
                    <div id="credits"></div>
                </div>
                <div class="course-info-item">
                    <label>类型</label>
                    <div id="type"></div>
                </div>
                <div class="course-info-item">
                    <label>所属院系</label>
                    <div id="department"></div>
                </div>
                <div class="course-info-item">
                    <label>状态</label>
                    <div id="status"></div>
                </div>
            </div>
            <div class="course-info-item" style="margin-top: 15px;">
                <label>课程描述</label>
                <div id="description"></div>
            </div>
        </div>
        
        <div class="tab-navigation">
            <button class="tab-button active" data-tab="sections">教学班管理</button>
            <button class="tab-button" data-tab="prereqs">先修课程</button>
        </div>
        
        <div id="sectionsTab" class="tab-content active">
            <div class="section-header">
                <h3>教学班列表</h3>
                <button class="btn-primary" id="addSectionBtn">添加教学班</button>
            </div>
            
            <table class="results-table" id="sectionsTable">
                <thead>
                    <tr>
                        <th>班级编号</th>
                        <th>学期</th>
                        <th>容量</th>
                        <th>已选人数</th>
                        <th>上课时间</th>
                        <th>教室</th>
                        <th>主讲教师</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="sectionsTableBody">
                    <!-- 数据将通过JavaScript动态填充 -->
                </tbody>
            </table>
            
            <div id="emptySections" class="empty-state" style="display: none;">
                <p>该课程暂未开设教学班</p>
            </div>
        </div>
        
        <div id="prereqsTab" class="tab-content">
            <div class="section-header">
                <h3>先修课程</h3>
                <button class="btn-primary" id="addPrereqBtn">添加先修课程</button>
            </div>
            
            <table class="results-table" id="prereqsTable">
                <thead>
                    <tr>
                        <th>课程ID</th>
                        <th>课程名称</th>
                        <th>学分</th>
                        <th>要求类型</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="prereqsTableBody">
                    <!-- 数据将通过JavaScript动态填充 -->
                </tbody>
            </table>
            
            <div id="emptyPrereqs" class="empty-state" style="display: none;">
                <p>该课程暂无先修课程要求</p>
            </div>
        </div>
    </div>
    
    <!-- 教学班模态框 -->
    <div id="sectionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="sectionModalTitle">添加教学班</h3>
                <span class="close-btn" id="closeSectionModal">&times;</span>
            </div>
            <form id="sectionForm">
                <input type="hidden" id="sectionEditMode" value="add">
                <input type="hidden" id="sectionId" value="">
                
                <div class="form-group">
                    <label for="sectionNumber">班级编号</label>
                    <input type="text" id="sectionNumber" required>
                </div>
                <div class="form-group">
                    <label for="semesterId">学期</label>
                    <select id="semesterId" required>
                        <!-- 学期选项将通过JavaScript动态填充 -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="capacity">容量</label>
                    <input type="number" id="capacity" min="1" required>
                </div>
                <div class="form-group">
                    <label for="timeSlotId">上课时间</label>
                    <select id="timeSlotId">
                        <option value="">选择时间段</option>
                        <!-- 时间段选项将通过JavaScript动态填充 -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="classroomId">教室</label>
                    <select id="classroomId">
                        <option value="">选择教室</option>
                        <!-- 教室选项将通过JavaScript动态填充 -->
                    </select>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn-secondary" id="cancelSectionBtn">取消</button>
                    <button type="submit" class="btn-primary" id="saveSectionBtn">保存</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 教师分配模态框 -->
    <div id="instructorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>分配教师</h3>
                <span class="close-btn" id="closeInstructorModal">&times;</span>
            </div>
            <form id="instructorForm">
                <input type="hidden" id="teachSectionId" value="">
                
                <div id="currentInstructors">
                    <h4>当前教师</h4>
                    <div id="instructorList">
                        <!-- 当前教师列表将通过JavaScript动态填充 -->
                    </div>
                </div>
                
                <div class="form-group" style="margin-top: 20px;">
                    <label for="instructorId">选择教师</label>
                    <select id="instructorId" required>
                        <option value="">选择教师</option>
                        <!-- 教师选项将通过JavaScript动态填充 -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="instructorRole">角色</label>
                    <select id="instructorRole" required>
                        <option value="主讲">主讲</option>
                        <option value="助教">助教</option>
                        <option value="实验">实验</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="workload">工作量</label>
                    <input type="number" id="workload" min="0" step="0.5" value="1.0">
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn-secondary" id="cancelInstructorBtn">取消</button>
                    <button type="submit" class="btn-primary" id="saveInstructorBtn">添加教师</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 先修课程模态框 -->
    <div id="prereqModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>添加先修课程</h3>
                <span class="close-btn" id="closePrereqModal">&times;</span>
            </div>
            <form id="prereqForm">
                <div class="form-group">
                    <label for="prereqCourseSearch">搜索课程</label>
                    <input type="text" id="prereqCourseSearch" placeholder="输入课程ID或名称搜索">
                </div>
                
                <div id="searchResults" style="max-height: 200px; overflow-y: auto; margin-bottom: 15px; display: none;">
                    <!-- 搜索结果将在这里显示 -->
                </div>
                
                <div class="form-group">
                    <label for="prereqCourseId">先修课程</label>
                    <input type="text" id="prereqCourseId" readonly required>
                    <input type="hidden" id="prereqCourseIdHidden">
                </div>
                
                <div class="form-group">
                    <label for="requirementType">要求类型</label>
                    <select id="requirementType" required>
                        <option value="必须">必须</option>
                        <option value="建议">建议</option>
                    </select>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn-secondary" id="cancelPrereqBtn">取消</button>
                    <button type="submit" class="btn-primary" id="savePrereqBtn">保存</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 获取URL参数
        const urlParams = new URLSearchParams(window.location.search);
        const courseId = urlParams.get('id');
        
        if (!courseId) {
            window.location.href = '/course_search';
            return;
        }
        
        // 获取DOM元素
        const loadingIndicator = document.getElementById('loadingIndicator');
        const courseContent = document.getElementById('courseContent');
        
        // 获取课程详情并填充页面
        function loadCourseDetails() {
            loadingIndicator.style.display = 'block';
            courseContent.style.display = 'none';
            
            fetch(`/api/admin/course/${courseId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`请求失败: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // 填充课程基本信息
                    document.getElementById('courseTitle').textContent = data.course.lyh_course_title;
                    document.getElementById('courseId').textContent = data.course.lyh_course_id;
                    document.getElementById('credits').textContent = data.course.lyh_credits;
                    document.getElementById('type').textContent = data.course.lyh_type;
                    document.getElementById('department').textContent = data.course.lyh_dept_name || '-';
                    
                    // 设置状态
                    const statusElement = document.getElementById('status');
                    if (data.course.lyh_is_active) {
                        statusElement.innerHTML = '<span class="badge badge-success">激活</span>';
                    } else {
                        statusElement.innerHTML = '<span class="badge badge-danger">禁用</span>';
                    }
                    
                    document.getElementById('description').textContent = data.course.lyh_description || '无描述';
                    
                    // 显示内容
                    loadingIndicator.style.display = 'none';
                    courseContent.style.display = 'block';
                    
                    // 加载教学班
                    loadSections();
                    
                    // 加载先修课程
                    loadPrerequisites();
                })
                .catch(error => {
                    console.error('获取课程详情失败:', error);
                    alert(`获取课程详情失败: ${error.message}`);
                    window.location.href = '/course_search';
                });
        }
        
        // 加载教学班
        function loadSections() {
            const sectionsTableBody = document.getElementById('sectionsTableBody');
            const emptySections = document.getElementById('emptySections');
            
            sectionsTableBody.innerHTML = '';
            
            fetch(`/api/admin/course/${courseId}/sections`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`请求失败: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    const sections = data.sections || [];
                    
                    if (sections.length === 0) {
                        emptySections.style.display = 'block';
                        return;
                    }
                    
                    emptySections.style.display = 'none';
                    
                    sections.forEach(section => {
                        const row = document.createElement('tr');
                        
                        row.innerHTML = `
                            <td>${section.lyh_section_number}</td>
                            <td>${section.lyh_semester_id}</td>
                            <td>${section.lyh_capacity}</td>
                            <td>${section.lyh_enrolled_count || 0}</td>
                            <td>${section.lyh_period_desc || '-'}</td>
                            <td>${section.lyh_room_number ? section.lyh_building_name + ' ' + section.lyh_room_number : '-'}</td>
                            <td>${section.lyh_instructor_name || '-'}</td>
                            <td>
                                <button class="btn-secondary edit-section-btn" data-id="${section.lyh_section_id}">编辑</button>
                                <button class="btn-secondary assign-instructor-btn" data-id="${section.lyh_section_id}">分配教师</button>
                                <button class="btn-danger delete-section-btn" data-id="${section.lyh_section_id}">删除</button>
                            </td>
                        `;
                        
                        sectionsTableBody.appendChild(row);
                    });
                    
                    // 绑定编辑按钮事件
                    document.querySelectorAll('.edit-section-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const sectionId = this.getAttribute('data-id');
                            editSection(sectionId);
                        });
                    });
                    
                    // 绑定分配教师按钮事件
                    document.querySelectorAll('.assign-instructor-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const sectionId = this.getAttribute('data-id');
                            assignInstructor(sectionId);
                        });
                    });
                    
                    // 绑定删除按钮事件
                    document.querySelectorAll('.delete-section-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const sectionId = this.getAttribute('data-id');
                            deleteSection(sectionId);
                        });
                    });
                })
                .catch(error => {
                    console.error('获取教学班列表失败:', error);
                    alert(`获取教学班列表失败: ${error.message}`);
                });
        }
        
        // 加载先修课程
        function loadPrerequisites() {
            const prereqsTableBody = document.getElementById('prereqsTableBody');
            const emptyPrereqs = document.getElementById('emptyPrereqs');
            
            prereqsTableBody.innerHTML = '';
            
            fetch(`/api/admin/course/${courseId}/prerequisites`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`请求失败: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    const prereqs = data.prerequisites || [];
                    
                    if (prereqs.length === 0) {
                        emptyPrereqs.style.display = 'block';
                        return;
                    }
                    
                    emptyPrereqs.style.display = 'none';
                    
                    prereqs.forEach(prereq => {
                        const row = document.createElement('tr');
                        
                        row.innerHTML = `
                            <td>${prereq.lyh_prereq_course_id}</td>
                            <td>${prereq.lyh_course_title}</td>
                            <td>${prereq.lyh_credits}</td>
                            <td>${prereq.lyh_requirement_type}</td>
                            <td>
                                <button class="btn-danger delete-prereq-btn" data-id="${prereq.lyh_prereq_id}">删除</button>
                            </td>
                        `;
                        
                        prereqsTableBody.appendChild(row);
                    });
                    
                    // 绑定删除按钮事件
                    document.querySelectorAll('.delete-prereq-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const prereqId = this.getAttribute('data-id');
                            deletePrerequisite(prereqId);
                        });
                    });
                })
                .catch(error => {
                    console.error('获取先修课程列表失败:', error);
                    alert(`获取先修课程列表失败: ${error.message}`);
                });
        }
        
        // 编辑教学班
        function editSection(sectionId) {
            const sectionModalTitle = document.getElementById('sectionModalTitle');
            const sectionEditMode = document.getElementById('sectionEditMode');
            const sectionIdInput = document.getElementById('sectionId');
            
            sectionModalTitle.textContent = '编辑教学班';
            sectionEditMode.value = 'edit';
            sectionIdInput.value = sectionId;
            
            // 获取教学班详情
            fetch(`/api/admin/section/${sectionId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`请求失败: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // 清空并重新加载学期选项
                    const semesterSelect = document.getElementById('semesterId');
                    semesterSelect.innerHTML = ''; // 清空现有选项
                    
                    // 清空并重新加载时间段选项
                    const timeSlotSelect = document.getElementById('timeSlotId');
                    timeSlotSelect.innerHTML = '';
                    
                    // 清空并重新加载教室选项
                    const classroomSelect = document.getElementById('classroomId');
                    classroomSelect.innerHTML = '';
                    
                    // 添加空选项
                    const emptyTimeSlotOption = document.createElement('option');
                    emptyTimeSlotOption.value = '';
                    emptyTimeSlotOption.textContent = '-- 请选择 --';
                    timeSlotSelect.appendChild(emptyTimeSlotOption);
                    
                    const emptyClassroomOption = document.createElement('option');
                    emptyClassroomOption.value = '';
                    emptyClassroomOption.textContent = '-- 请选择 --';
                    classroomSelect.appendChild(emptyClassroomOption);
                    
                    // 填充其他表单字段
                    document.getElementById('sectionNumber').value = data.section.lyh_section_number;
                    document.getElementById('capacity').value = data.section.lyh_capacity;
                    
                    // 并行加载所有选项数据
                    Promise.all([
                        // 加载学期选项
                        fetch('/api/admin/semesters').then(res => res.json()),
                        // 加载时间段选项
                        fetch('/api/admin/time_slots').then(res => res.json()),
                        // 加载教室选项
                        fetch('/api/admin/classrooms').then(res => res.json())
                    ])
                    .then(([semestersData, timeSlotsData, classroomsData]) => {
                        // 填充学期选项
                        const semesters = Array.isArray(semestersData) ? semestersData : [];
                        semesters.forEach(semester => {
                            const option = document.createElement('option');
                            option.value = semester.lyh_semester_id;
                            option.textContent = semester.lyh_semester_name || semester.lyh_semester_id;
                            semesterSelect.appendChild(option);
                        });
                        
                        // 填充时间段选项
                        const timeSlots = Array.isArray(timeSlotsData) ? timeSlotsData : [];
                        timeSlots.forEach(timeSlot => {
                            const option = document.createElement('option');
                            option.value = timeSlot.lyh_time_slot_id;
                            option.textContent = timeSlot.lyh_period_desc;
                            timeSlotSelect.appendChild(option);
                        });
                        
                        // 填充教室选项
                        const classrooms = Array.isArray(classroomsData) ? classroomsData : [];
                        classrooms.forEach(classroom => {
                            const option = document.createElement('option');
                            option.value = classroom.lyh_classroom_id;
                            option.textContent = classroom.lyh_building_name + ' ' + classroom.lyh_room_number;
                            classroomSelect.appendChild(option);
                        });
                        
                        // 设置选中的值
                        semesterSelect.value = data.section.lyh_semester_id;
                        timeSlotSelect.value = data.section.lyh_time_slot_id || '';
                        classroomSelect.value = data.section.lyh_classroom_id || '';
                    })
                    .catch(error => {
                        console.error('加载选项数据失败:', error);
                    });
                    
                    // 显示模态框
                    document.getElementById('sectionModal').style.display = 'block';
                })
                .catch(error => {
                    console.error('获取教学班详情失败:', error);
                    alert(`获取教学班详情失败: ${error.message}`);
                });
        }
        
        // 删除教学班
        function deleteSection(sectionId) {
            if (confirm('确定要删除这个教学班吗？此操作无法恢复，且会删除相关的授课记录和选课记录。')) {
                fetch(`/api/admin/section/${sectionId}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(data => {
                            throw new Error(data.error || `请求失败: ${response.status}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    alert(data.message || '教学班删除成功');
                    loadSections(); // 重新加载教学班列表
                })
                .catch(error => {
                    console.error('删除教学班失败:', error);
                    alert(`删除失败: ${error.message}`);
                });
            }
        }
        
        // 分配教师
        function assignInstructor(sectionId) {
            document.getElementById('teachSectionId').value = sectionId;
            document.getElementById('instructorList').innerHTML = '';
            
            // 获取当前教师列表
            fetch(`/api/admin/section/${sectionId}/instructors`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`请求失败: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    const instructorList = document.getElementById('instructorList');
                    const instructors = data.instructors || [];
                    
                    if (instructors.length === 0) {
                        instructorList.innerHTML = '<p>暂无分配的教师</p>';
                    } else {
                        instructors.forEach(instructor => {
                            const instructorItem = document.createElement('div');
                            instructorItem.className = 'instructor-item';
                            
                            instructorItem.innerHTML = `
                                <div>
                                    <strong>${instructor.lyh_instructor_name}</strong>
                                    <span>(${instructor.lyh_role})</span>
                                    <div>工作量: ${instructor.lyh_workload || 0}</div>
                                </div>
                                <button type="button" class="btn-danger remove-instructor-btn" 
                                    data-teach-id="${instructor.lyh_teach_id}">删除</button>
                            `;
                            
                            instructorList.appendChild(instructorItem);
                        });
                        
                        // 绑定删除教师按钮事件
                        document.querySelectorAll('.remove-instructor-btn').forEach(btn => {
                            btn.addEventListener('click', function() {
                                const teachId = this.getAttribute('data-teach-id');
                                removeInstructor(teachId);
                            });
                        });
                    }
                    
                    // 显示模态框
                    document.getElementById('instructorModal').style.display = 'block';
                })
                .catch(error => {
                    console.error('获取教师列表失败:', error);
                    alert(`获取教师列表失败: ${error.message}`);
                });
        }
        
        // 删除教师授课关系
        function removeInstructor(teachId) {
            if (confirm('确定要移除这位教师吗？')) {
                fetch(`/api/admin/teaches/${teachId}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(data => {
                            throw new Error(data.error || `请求失败: ${response.status}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    // 重新加载教师列表
                    assignInstructor(document.getElementById('teachSectionId').value);
                    
                    // 更新教学班列表中的主讲教师显示
                    loadSections();
                })
                .catch(error => {
                    console.error('移除教师失败:', error);
                    alert(`移除教师失败: ${error.message}`);
                });
            }
        }
        
        // 删除先修课程
        function deletePrerequisite(prereqId) {
            if (confirm('确定要删除这个先修课程要求吗？')) {
                fetch(`/api/admin/prerequisite/${prereqId}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(data => {
                            throw new Error(data.error || `请求失败: ${response.status}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    alert(data.message || '先修课程要求删除成功');
                    loadPrerequisites(); // 重新加载先修课程列表
                })
                .catch(error => {
                    console.error('删除先修课程要求失败:', error);
                    alert(`删除失败: ${error.message}`);
                });
            }
        }
        
        // 加载下拉选项数据
        function loadFormOptions() {
            // 加载学期选项
            fetch('/api/admin/semesters')
                .then(response => response.json())
                .then(data => {
                    // 填充学期选项
                    const semesterSelect = document.getElementById('semesterId');
                    // 确保data是数组
                    const semesters = Array.isArray(data) ? data : [];
                    semesters.forEach(semester => {
                        const option = document.createElement('option');
                        option.value = semester.lyh_semester_id;
                        option.textContent = semester.lyh_semester_name;
                        semesterSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('获取学期选项失败:', error);
                    alert(`获取学期选项失败: ${error.message}`);
                });
            
            // 加载时间段选项
            fetch('/api/admin/time_slots')
                .then(response => response.json())
                .then(data => {
                    // 填充时间段选项
                    const timeSlotSelect = document.getElementById('timeSlotId');
                    // 确保data是数组
                    const timeSlots = Array.isArray(data) ? data : [];
                    timeSlots.forEach(timeSlot => {
                        const option = document.createElement('option');
                        option.value = timeSlot.lyh_time_slot_id;
                        option.textContent = timeSlot.lyh_period_desc;
                        timeSlotSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('获取时间段选项失败:', error);
                    alert(`获取时间段选项失败: ${error.message}`);
                });
            
            // 加载教室选项
            fetch('/api/admin/classrooms')
                .then(response => response.json())
                .then(data => {
                    // 填充教室选项
                    const classroomSelect = document.getElementById('classroomId');
                    // 确保data是数组
                    const classrooms = Array.isArray(data) ? data : [];
                    classrooms.forEach(classroom => {
                        const option = document.createElement('option');
                        option.value = classroom.lyh_classroom_id;
                        option.textContent = classroom.lyh_building_name + ' ' + classroom.lyh_room_number;
                        classroomSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('获取教室选项失败:', error);
                    alert(`获取教室选项失败: ${error.message}`);
                });
                
            // 加载教师选项
            fetch('/api/admin/instructors')
                .then(response => response.json())
                .then(data => {
                    // 填充教师选项
                    const instructorSelect = document.getElementById('instructorId');
                    data.instructors.forEach(instructor => {
                        const option = document.createElement('option');
                        option.value = instructor.lyh_instructor_id;
                        option.textContent = `${instructor.lyh_instructor_name} (${instructor.lyh_title || '未知职称'})`;
                        instructorSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('获取教师选项失败:', error);
                    alert(`获取教师选项失败: ${error.message}`);
                });
        }
        
        // 添加教学班
        function addSection() {
            const sectionModalTitle = document.getElementById('sectionModalTitle');
            const sectionEditMode = document.getElementById('sectionEditMode');
            const sectionIdInput = document.getElementById('sectionId');
            const sectionForm = document.getElementById('sectionForm');
            
            sectionModalTitle.textContent = '添加教学班';
            sectionEditMode.value = 'add';
            sectionIdInput.value = '';
            sectionForm.reset();
            
            // 清空并重新加载选项
            const semesterSelect = document.getElementById('semesterId');
            const timeSlotSelect = document.getElementById('timeSlotId');
            const classroomSelect = document.getElementById('classroomId');
            
            semesterSelect.innerHTML = '';
            timeSlotSelect.innerHTML = '';
            classroomSelect.innerHTML = '';
            
            // 添加空选项
            const emptyTimeSlotOption = document.createElement('option');
            emptyTimeSlotOption.value = '';
            emptyTimeSlotOption.textContent = '-- 请选择 --';
            timeSlotSelect.appendChild(emptyTimeSlotOption);
            
            const emptyClassroomOption = document.createElement('option');
            emptyClassroomOption.value = '';
            emptyClassroomOption.textContent = '-- 请选择 --';
            classroomSelect.appendChild(emptyClassroomOption);
            
            // 并行加载所有选项数据
            Promise.all([
                // 加载学期选项
                fetch('/api/admin/semesters').then(res => res.json()),
                // 加载时间段选项
                fetch('/api/admin/time_slots').then(res => res.json()),
                // 加载教室选项
                fetch('/api/admin/classrooms').then(res => res.json())
            ])
            .then(([semestersData, timeSlotsData, classroomsData]) => {
                // 填充学期选项
                const semesters = Array.isArray(semestersData) ? semestersData : [];
                semesters.forEach(semester => {
                    const option = document.createElement('option');
                    option.value = semester.lyh_semester_id;
                    option.textContent = semester.lyh_semester_name || semester.lyh_semester_id;
                    semesterSelect.appendChild(option);
                });
                
                // 填充时间段选项
                const timeSlots = Array.isArray(timeSlotsData) ? timeSlotsData : [];
                timeSlots.forEach(timeSlot => {
                    const option = document.createElement('option');
                    option.value = timeSlot.lyh_time_slot_id;
                    option.textContent = timeSlot.lyh_period_desc;
                    timeSlotSelect.appendChild(option);
                });
                
                // 填充教室选项
                const classrooms = Array.isArray(classroomsData) ? classroomsData : [];
                classrooms.forEach(classroom => {
                    const option = document.createElement('option');
                    option.value = classroom.lyh_classroom_id;
                    option.textContent = classroom.lyh_building_name + ' ' + classroom.lyh_room_number;
                    classroomSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('加载选项数据失败:', error);
            });
            
            // 显示模态框
            document.getElementById('sectionModal').style.display = 'block';
        }
        
        // 保存教学班
        function saveSection(event) {
            event.preventDefault();
            
            const sectionData = {
                course_id: courseId,
                section_number: document.getElementById('sectionNumber').value,
                semester_id: document.getElementById('semesterId').value,
                capacity: parseInt(document.getElementById('capacity').value),
                time_slot_id: document.getElementById('timeSlotId').value || null,
                classroom_id: document.getElementById('classroomId').value || null
            };
            
            const isEdit = document.getElementById('sectionEditMode').value === 'edit';
            const sectionId = document.getElementById('sectionId').value;
            
            const url = isEdit ? `/api/admin/section/${sectionId}` : '/api/admin/section';
            const method = isEdit ? 'PUT' : 'POST';
            
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(sectionData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error || `请求失败: ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                // 关闭模态框
                document.getElementById('sectionModal').style.display = 'none';
                
                // 显示成功消息
                alert(data.message || '操作成功');
                
                // 重新加载教学班列表
                loadSections();
            })
            .catch(error => {
                console.error('保存教学班失败:', error);
                alert(`保存失败: ${error.message}`);
            });
        }
        
        // 添加教师授课关系
        function saveInstructor(event) {
            event.preventDefault();
            
            const teachData = {
                section_id: document.getElementById('teachSectionId').value,
                instructor_id: document.getElementById('instructorId').value,
                role: document.getElementById('instructorRole').value,
                workload: parseFloat(document.getElementById('workload').value)
            };
            
            fetch('/api/admin/teaches', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(teachData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error || `请求失败: ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                // 重新加载教师列表
                assignInstructor(document.getElementById('teachSectionId').value);
                
                // 重置表单
                document.getElementById('instructorId').value = '';
                document.getElementById('instructorRole').value = '主讲';
                document.getElementById('workload').value = '1.0';
                
                // 更新教学班列表中的主讲教师显示
                loadSections();
            })
            .catch(error => {
                console.error('添加教师失败:', error);
                alert(`添加教师失败: ${error.message}`);
            });
        }
        
        // 添加先修课程
        function addPrerequisite() {
            // 重置表单
            document.getElementById('prereqForm').reset();
            document.getElementById('prereqCourseId').value = '';
            document.getElementById('prereqCourseIdHidden').value = '';
            document.getElementById('searchResults').style.display = 'none';
            
            // 显示模态框
            document.getElementById('prereqModal').style.display = 'block';
        }
        
        // 搜索课程
        let searchTimeout;
        document.getElementById('prereqCourseSearch').addEventListener('input', function() {
            const searchTerm = this.value.trim();
            
            // 清除之前的定时器
            clearTimeout(searchTimeout);
            
            if (searchTerm.length < 2) {
                document.getElementById('searchResults').style.display = 'none';
                return;
            }
            
            // 设置新的定时器，延迟300ms执行搜索
            searchTimeout = setTimeout(function() {
                fetch(`/api/admin/courses/search?query=${encodeURIComponent(searchTerm)}&exclude_id=${courseId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`请求失败: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        const searchResults = document.getElementById('searchResults');
                        searchResults.innerHTML = '';
                        
                        if (data.courses && data.courses.length > 0) {
                            const resultsList = document.createElement('ul');
                            resultsList.style.listStyle = 'none';
                            resultsList.style.padding = '0';
                            resultsList.style.margin = '0';
                            
                            data.courses.forEach(course => {
                                const listItem = document.createElement('li');
                                listItem.style.padding = '8px 12px';
                                listItem.style.borderBottom = '1px solid #eee';
                                listItem.style.cursor = 'pointer';
                                listItem.style.display = 'flex';
                                listItem.style.justifyContent = 'space-between';
                                
                                listItem.innerHTML = `
                                    <div>
                                        <strong>${course.lyh_course_id}</strong> - ${course.lyh_course_title}
                                    </div>
                                    <div>
                                        ${course.lyh_credits}学分
                                    </div>
                                `;
                                
                                listItem.addEventListener('click', function() {
                                    document.getElementById('prereqCourseId').value = `${course.lyh_course_id} - ${course.lyh_course_title}`;
                                    document.getElementById('prereqCourseIdHidden').value = course.lyh_course_id;
                                    searchResults.style.display = 'none';
                                    document.getElementById('prereqCourseSearch').value = '';
                                });
                                
                                listItem.addEventListener('mouseover', function() {
                                    this.style.backgroundColor = '#f5f5f5';
                                });
                                
                                listItem.addEventListener('mouseout', function() {
                                    this.style.backgroundColor = 'transparent';
                                });
                                
                                resultsList.appendChild(listItem);
                            });
                            
                            searchResults.appendChild(resultsList);
                            searchResults.style.display = 'block';
                        } else {
                            searchResults.innerHTML = '<p style="padding: 10px; color: #666;">未找到匹配的课程</p>';
                            searchResults.style.display = 'block';
                        }
                    })
                    .catch(error => {
                        console.error('搜索课程失败:', error);
                        const searchResults = document.getElementById('searchResults');
                        searchResults.innerHTML = '<p style="padding: 10px; color: #f44336;">搜索失败，请重试</p>';
                        searchResults.style.display = 'block';
                    });
            }, 300);
        });
        
        // 保存先修课程
        document.getElementById('prereqForm').addEventListener('submit', function(event) {
            event.preventDefault();
            
            const prereqCourseId = document.getElementById('prereqCourseIdHidden').value;
            if (!prereqCourseId) {
                alert('请选择先修课程');
                return;
            }
            
            const prereqData = {
                course_id: courseId,
                prereq_course_id: prereqCourseId,
                requirement_type: document.getElementById('requirementType').value
            };
            
            fetch('/api/admin/prerequisite', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(prereqData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error || `请求失败: ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                // 关闭模态框
                document.getElementById('prereqModal').style.display = 'none';
                
                // 显示成功消息
                alert(data.message || '先修课程添加成功');
                
                // 重新加载先修课程列表
                loadPrerequisites();
            })
            .catch(error => {
                console.error('添加先修课程失败:', error);
                alert(`添加失败: ${error.message}`);
            });
        });
        
        // 选项卡切换
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', function() {
                // 移除所有选项卡的激活状态
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // 隐藏所有内容
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                // 激活当前选项卡
                this.classList.add('active');
                
                // 显示对应内容
                const tabId = this.getAttribute('data-tab');
                document.getElementById(tabId + 'Tab').classList.add('active');
            });
        });
        
        // 模态框事件
        document.getElementById('addSectionBtn').addEventListener('click', addSection);
        document.getElementById('addPrereqBtn').addEventListener('click', addPrerequisite);
        document.getElementById('sectionForm').addEventListener('submit', saveSection);
        document.getElementById('instructorForm').addEventListener('submit', saveInstructor);
        
        // 关闭模态框
        document.getElementById('closeSectionModal').addEventListener('click', function() {
            document.getElementById('sectionModal').style.display = 'none';
        });
        document.getElementById('closeInstructorModal').addEventListener('click', function() {
            document.getElementById('instructorModal').style.display = 'none';
        });
        document.getElementById('cancelSectionBtn').addEventListener('click', function() {
            document.getElementById('sectionModal').style.display = 'none';
        });
        document.getElementById('cancelInstructorBtn').addEventListener('click', function() {
            document.getElementById('instructorModal').style.display = 'none';
        });
        
        // 关闭先修课程模态框
        document.getElementById('closePrereqModal').addEventListener('click', function() {
            document.getElementById('prereqModal').style.display = 'none';
        });
        document.getElementById('cancelPrereqBtn').addEventListener('click', function() {
            document.getElementById('prereqModal').style.display = 'none';
        });
        
        // 点击模态框外部关闭
        window.addEventListener('click', function(event) {
            if (event.target === document.getElementById('sectionModal')) {
                document.getElementById('sectionModal').style.display = 'none';
            }
            if (event.target === document.getElementById('instructorModal')) {
                document.getElementById('instructorModal').style.display = 'none';
            }
            if (event.target === document.getElementById('prereqModal')) {
                document.getElementById('prereqModal').style.display = 'none';
            }
        });
        
        // 初始化页面
        loadCourseDetails();
    });
</script>
{% endblock %}
