{% extends "base.html" %}

{% block title %}系统设置 - 教务管理系统{% endblock %}

{% block head_extra %}
<style>
    .system-settings-container {
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
    }
    .page-header {
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #4CAF50;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .card {
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        padding: 20px;
    }
    .card-header {
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .card-header h3 {
        margin: 0;
        color: #4CAF50;
    }
    .btn-primary {
        background-color: #4CAF50;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
    }
    .btn-primary:hover {
        background-color: #45a049;
    }
    .btn-secondary {
        background-color: #2196f3;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }
    .btn-secondary:hover {
        background-color: #1976d2;
    }
    .btn-danger {
        background-color: #f44336;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
    }
    .btn-danger:hover {
        background-color: #d32f2f;
    }
    .form-group {
        margin-bottom: 15px;
    }
    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
    }
    .form-group input, .form-group select, .form-group textarea {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
    }
    .form-group textarea {
        min-height: 150px;
        resize: vertical;
    }
    .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
    }
    .form-error {
        color: #f44336;
        font-size: 14px;
        margin-top: 5px;
    }
    .announcements-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }
    .announcements-table th {
        background-color: #f5f5f5;
        padding: 10px;
        text-align: left;
        border-bottom: 2px solid #ddd;
    }
    .announcements-table td {
        padding: 10px;
        border-bottom: 1px solid #eee;
    }
    .announcements-table tr:hover {
        background-color: #f9f9f9;
    }
    .badge {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
    }
    .badge-active {
        background-color: #4caf50;
        color: white;
    }
    .badge-inactive {
        background-color: #9e9e9e;
        color: white;
    }
    .badge-important {
        background-color: #f44336;
        color: white;
    }
    .badge-normal {
        background-color: #2196f3;
        color: white;
    }
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 20px;
        border-radius: 8px;
        width: 80%;
        max-width: 700px;
        max-height: 80vh;
        overflow-y: auto;
    }
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
    }
    .modal-header h3 {
        margin: 0;
        color: #4CAF50;
    }
    .close-button {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #666;
    }
    .loading {
        text-align: center;
        padding: 40px;
    }
    .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #4CAF50;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .empty-state {
        text-align: center;
        padding: 40px;
        color: #666;
    }
    .empty-state i {
        font-size: 48px;
        margin-bottom: 10px;
        color: #ddd;
    }
</style>
{% endblock %}

{% block content %}
<div class="system-settings-container">
    <div class="page-header">
        <h1>系统设置</h1>
    </div>
    
    <!-- 公告管理卡片 -->
    <div class="card">
        <div class="card-header">
            <h3>公告管理</h3>
            <button class="btn-primary" id="addAnnouncementBtn">发布新公告</button>
        </div>
        
        <div id="loadingIndicator" class="loading" style="display: none;">
            <div class="loading-spinner"></div>
            <p>加载数据中...</p>
        </div>
        
        <table class="announcements-table" id="announcementsTable">
            <thead>
                <tr>
                    <th>标题</th>
                    <th>发布时间</th>
                    <th>截止时间</th>
                    <th>状态</th>
                    <th>重要性</th>
                    <th>目标用户</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="announcementsTableBody">
                <!-- 数据将通过JavaScript动态填充 -->
            </tbody>
        </table>
        
        <div id="emptyState" class="empty-state" style="display: none;">
            <i class="fas fa-bullhorn"></i>
            <p>暂无公告数据</p>
        </div>
    </div>
</div>

<!-- 添加/编辑公告模态框 -->
<div id="announcementModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">发布新公告</h3>
            <button class="close-button" id="closeModal">&times;</button>
        </div>
        <form id="announcementForm">
            <input type="hidden" id="isEditMode" value="false">
            <input type="hidden" id="announcementId" value="">
            
            <div class="form-group">
                <label for="title">公告标题 *</label>
                <input type="text" id="title" required>
                <div class="form-error" id="titleError"></div>
            </div>
            
            <div class="form-group">
                <label for="content">公告内容 *</label>
                <textarea id="content" required></textarea>
                <div class="form-error" id="contentError"></div>
            </div>
            
            <div class="form-group">
                <label for="startDate">发布时间 *</label>
                <input type="datetime-local" id="startDate" required>
                <div class="form-error" id="startDateError"></div>
            </div>
            
            <div class="form-group">
                <label for="endDate">截止时间</label>
                <input type="datetime-local" id="endDate">
                <div class="form-error" id="endDateError"></div>
            </div>
            
            <div class="form-group">
                <label for="importance">重要性</label>
                <select id="importance">
                    <option value="normal">普通</option>
                    <option value="important">重要</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="targetUsers">目标用户</label>
                <select id="targetUsers">
                    <option value="all">所有用户</option>
                    <option value="students">仅学生</option>
                    <option value="instructors">仅教师</option>
                    <option value="admins">仅管理员</option>
                </select>
            </div>
            
            <div class="form-error" id="formError"></div>
            
            <div class="form-actions">
                <button type="button" class="btn-secondary" id="cancelBtn">取消</button>
                <button type="submit" class="btn-primary" id="saveBtn">发布公告</button>
            </div>
        </form>
    </div>
</div>

<!-- 查看公告详情模态框 -->
<div id="viewAnnouncementModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="viewModalTitle">公告详情</h3>
            <button class="close-button" id="closeViewModal">&times;</button>
        </div>
        
        <div class="detail-content">
            <h4 id="view-title"></h4>
            <p><small>发布时间: <span id="view-startDate"></span> | 截止时间: <span id="view-endDate"></span></small></p>
            <p><small>重要性: <span id="view-importance"></span> | 目标用户: <span id="view-targetUsers"></span></small></p>
            <hr>
            <div id="view-content" style="white-space: pre-wrap;"></div>
        </div>
        
        <div class="form-actions">
            <button type="button" class="btn-secondary" id="closeDetailBtn">关闭</button>
            <button type="button" class="btn-secondary" id="editAnnouncementBtn">编辑</button>
            <button type="button" class="btn-danger" id="deleteAnnouncementBtn">删除</button>
        </div>
    </div>
</div>

<!-- 确认删除模态框 -->
<div id="confirmDeleteModal" class="modal">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h3>确认删除</h3>
            <button class="close-button" id="closeConfirmModal">&times;</button>
        </div>
        <p>确定要删除该公告吗？此操作不可逆。</p>
        <div id="deleteErrorMessage" class="form-error" style="display: none;"></div>
        <div class="form-actions">
            <button type="button" class="btn-secondary" id="cancelDeleteBtn">取消</button>
            <button type="button" class="btn-danger" id="confirmDeleteBtn">确认删除</button>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 全局变量
        let currentAnnouncementId = null;
        let announcements = [];
        
        // 获取DOM元素
        const announcementsTable = document.getElementById('announcementsTable');
        const announcementsTableBody = document.getElementById('announcementsTableBody');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const emptyState = document.getElementById('emptyState');
        const addAnnouncementBtn = document.getElementById('addAnnouncementBtn');
        
        // 模态框元素
        const announcementModal = document.getElementById('announcementModal');
        const viewAnnouncementModal = document.getElementById('viewAnnouncementModal');
        const confirmDeleteModal = document.getElementById('confirmDeleteModal');
        const modalTitle = document.getElementById('modalTitle');
        const closeModal = document.getElementById('closeModal');
        const closeViewModal = document.getElementById('closeViewModal');
        const closeConfirmModal = document.getElementById('closeConfirmModal');
        const announcementForm = document.getElementById('announcementForm');
        const isEditMode = document.getElementById('isEditMode');
        const announcementId = document.getElementById('announcementId');
        const cancelBtn = document.getElementById('cancelBtn');
        const closeDetailBtn = document.getElementById('closeDetailBtn');
        const editAnnouncementBtn = document.getElementById('editAnnouncementBtn');
        const deleteAnnouncementBtn = document.getElementById('deleteAnnouncementBtn');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        
        // 模拟公告数据
        const mockAnnouncements = [
            {
                id: 1,
                title: '2024年秋季学期选课通知',
                content: '各位同学：\n\n2024年秋季学期选课将于2024年8月15日开始，请各位同学及时登录系统进行选课。选课分为预选和正选两个阶段，预选阶段为8月15日至8月20日，正选阶段为8月25日至8月30日。\n\n请各位同学注意选课时间，避免错过选课。',
                start_date: '2024-08-01T08:00:00',
                end_date: '2024-08-30T23:59:59',
                status: 'active',
                importance: 'important',
                target_users: 'students'
            },
            {
                id: 2,
                title: '系统维护通知',
                content: '尊敬的用户：\n\n我们将于2024年7月10日凌晨2:00-6:00进行系统维护，届时系统将暂停服务。给您带来的不便，敬请谅解。',
                start_date: '2024-07-08T10:00:00',
                end_date: '2024-07-10T06:00:00',
                status: 'active',
                importance: 'normal',
                target_users: 'all'
            },
            {
                id: 3,
                title: '教师评分提交截止日期提醒',
                content: '各位教师：\n\n请于2024年7月15日前完成本学期所有课程的成绩评定与提交工作。逾期未提交将影响学生成绩单生成及毕业审核工作。',
                start_date: '2024-07-01T08:00:00',
                end_date: '2024-07-15T23:59:59',
                status: 'active',
                importance: 'important',
                target_users: 'instructors'
            }
        ];
        
        // 加载公告数据
        function loadAnnouncements() {
            loadingIndicator.style.display = 'block';
            announcementsTable.style.display = 'none';
            emptyState.style.display = 'none';
            
            // 模拟API请求
            setTimeout(() => {
                announcements = mockAnnouncements;
                renderAnnouncementsTable();
                loadingIndicator.style.display = 'none';
            }, 500);
        }
        
        // 渲染公告表格
        function renderAnnouncementsTable() {
            announcementsTableBody.innerHTML = '';
            
            if (announcements.length === 0) {
                announcementsTable.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            announcements.forEach(announcement => {
                const startDate = new Date(announcement.start_date);
                const endDate = announcement.end_date ? new Date(announcement.end_date) : null;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${announcement.title}</td>
                    <td>${startDate.toLocaleString()}</td>
                    <td>${endDate ? endDate.toLocaleString() : '-'}</td>
                    <td>
                        <span class="badge badge-${announcement.status === 'active' ? 'active' : 'inactive'}">
                            ${announcement.status === 'active' ? '生效中' : '已过期'}
                        </span>
                    </td>
                    <td>
                        <span class="badge badge-${announcement.importance === 'important' ? 'important' : 'normal'}">
                            ${announcement.importance === 'important' ? '重要' : '普通'}
                        </span>
                    </td>
                    <td>${getTargetUsersText(announcement.target_users)}</td>
                    <td>
                        <button class="btn-secondary view-btn" data-id="${announcement.id}">查看</button>
                        <button class="btn-secondary edit-btn" data-id="${announcement.id}">编辑</button>
                        <button class="btn-danger delete-btn" data-id="${announcement.id}">删除</button>
                    </td>
                `;
                announcementsTableBody.appendChild(row);
            });
            
            // 添加事件监听器
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    viewAnnouncementDetail(id);
                });
            });
            
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    editAnnouncement(id);
                });
            });
            
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    showDeleteConfirmation(id);
                });
            });
            
            announcementsTable.style.display = 'table';
            emptyState.style.display = 'none';
        }
        
        // 获取目标用户文本
        function getTargetUsersText(targetUsers) {
            switch(targetUsers) {
                case 'all': return '所有用户';
                case 'students': return '仅学生';
                case 'instructors': return '仅教师';
                case 'admins': return '仅管理员';
                default: return '未知';
            }
        }
        
        // 查看公告详情
        function viewAnnouncementDetail(id) {
            currentAnnouncementId = id;
            const announcement = announcements.find(a => a.id === id);
            
            if (announcement) {
                document.getElementById('viewModalTitle').textContent = '公告详情';
                document.getElementById('view-title').textContent = announcement.title;
                document.getElementById('view-content').textContent = announcement.content;
                
                const startDate = new Date(announcement.start_date);
                document.getElementById('view-startDate').textContent = startDate.toLocaleString();
                
                if (announcement.end_date) {
                    const endDate = new Date(announcement.end_date);
                    document.getElementById('view-endDate').textContent = endDate.toLocaleString();
                } else {
                    document.getElementById('view-endDate').textContent = '无截止日期';
                }
                
                document.getElementById('view-importance').textContent = 
                    announcement.importance === 'important' ? '重要' : '普通';
                document.getElementById('view-targetUsers').textContent = 
                    getTargetUsersText(announcement.target_users);
                
                viewAnnouncementModal.style.display = 'block';
            }
        }
        
        // 添加公告
        function addAnnouncement() {
            isEditMode.value = 'false';
            announcementId.value = '';
            modalTitle.textContent = '发布新公告';
            document.getElementById('saveBtn').textContent = '发布公告';
            
            // 重置表单
            announcementForm.reset();
            document.getElementById('titleError').textContent = '';
            document.getElementById('contentError').textContent = '';
            document.getElementById('startDateError').textContent = '';
            document.getElementById('endDateError').textContent = '';
            document.getElementById('formError').textContent = '';
            
            // 设置默认发布时间为当前时间
            const now = new Date();
            const formattedDate = now.toISOString().slice(0, 16);
            document.getElementById('startDate').value = formattedDate;
            
            // 显示模态框
            announcementModal.style.display = 'block';
        }
        
        // 编辑公告
        function editAnnouncement(id) {
            const announcement = announcements.find(a => a.id === id);
            
            if (announcement) {
                isEditMode.value = 'true';
                announcementId.value = announcement.id;
                modalTitle.textContent = '编辑公告';
                document.getElementById('saveBtn').textContent = '保存修改';
                
                // 填充表单
                document.getElementById('title').value = announcement.title;
                document.getElementById('content').value = announcement.content;
                document.getElementById('startDate').value = announcement.start_date.slice(0, 16);
                document.getElementById('endDate').value = announcement.end_date ? announcement.end_date.slice(0, 16) : '';
                document.getElementById('importance').value = announcement.importance;
                document.getElementById('targetUsers').value = announcement.target_users;
                
                // 清除错误信息
                document.getElementById('titleError').textContent = '';
                document.getElementById('contentError').textContent = '';
                document.getElementById('startDateError').textContent = '';
                document.getElementById('endDateError').textContent = '';
                document.getElementById('formError').textContent = '';
                
                // 显示模态框
                announcementModal.style.display = 'block';
                
                // 如果是从详情页编辑，关闭详情模态框
                viewAnnouncementModal.style.display = 'none';
            }
        }
        
        // 显示删除确认
        function showDeleteConfirmation(id) {
            currentAnnouncementId = id;
            
            // 显示模态框
            confirmDeleteModal.style.display = 'block';
            
            // 如果是从详情页删除，关闭详情模态框
            viewAnnouncementModal.style.display = 'none';
        }
        
        // 处理删除
        function handleDelete() {
            // 模拟删除操作
            announcements = announcements.filter(a => a.id !== currentAnnouncementId);
            
            // 重新渲染表格
            renderAnnouncementsTable();
            
            // 关闭模态框
            confirmDeleteModal.style.display = 'none';
            
            // 显示成功消息
            alert('公告已成功删除');
        }
        
        // 处理表单提交
        announcementForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // 获取表单数据
            const formData = {
                title: document.getElementById('title').value.trim(),
                content: document.getElementById('content').value.trim(),
                start_date: document.getElementById('startDate').value,
                end_date: document.getElementById('endDate').value || null,
                importance: document.getElementById('importance').value,
                target_users: document.getElementById('targetUsers').value,
                status: 'active'
            };
            
            // 表单验证
            let hasError = false;
            
            if (!formData.title) {
                document.getElementById('titleError').textContent = '请输入公告标题';
                hasError = true;
            } else {
                document.getElementById('titleError').textContent = '';
            }
            
            if (!formData.content) {
                document.getElementById('contentError').textContent = '请输入公告内容';
                hasError = true;
            } else {
                document.getElementById('contentError').textContent = '';
            }
            
            if (!formData.start_date) {
                document.getElementById('startDateError').textContent = '请选择发布时间';
                hasError = true;
            } else {
                document.getElementById('startDateError').textContent = '';
            }
            
            if (hasError) {
                return;
            }
            
            // 处理编辑或添加
            if (isEditMode.value === 'true') {
                // 编辑现有公告
                const id = parseInt(announcementId.value);
                const index = announcements.findIndex(a => a.id === id);
                
                if (index !== -1) {
                    announcements[index] = {
                        ...announcements[index],
                        ...formData
                    };
                }
                
                alert('公告已成功更新');
            } else {
                // 添加新公告
                const newAnnouncement = {
                    id: announcements.length > 0 ? Math.max(...announcements.map(a => a.id)) + 1 : 1,
                    ...formData
                };
                
                announcements.push(newAnnouncement);
                alert('公告已成功发布');
            }
            
            // 重新渲染表格
            renderAnnouncementsTable();
            
            // 关闭模态框
            announcementModal.style.display = 'none';
        });
        
        // 事件绑定
        addAnnouncementBtn.addEventListener('click', addAnnouncement);
        closeModal.addEventListener('click', function() { announcementModal.style.display = 'none'; });
        closeViewModal.addEventListener('click', function() { viewAnnouncementModal.style.display = 'none'; });
        closeConfirmModal.addEventListener('click', function() { confirmDeleteModal.style.display = 'none'; });
        cancelBtn.addEventListener('click', function() { announcementModal.style.display = 'none'; });
        closeDetailBtn.addEventListener('click', function() { viewAnnouncementModal.style.display = 'none'; });
        editAnnouncementBtn.addEventListener('click', function() { 
            editAnnouncement(currentAnnouncementId); 
        });
        deleteAnnouncementBtn.addEventListener('click', function() { 
            showDeleteConfirmation(currentAnnouncementId); 
        });
        cancelDeleteBtn.addEventListener('click', function() { confirmDeleteModal.style.display = 'none'; });
        confirmDeleteBtn.addEventListener('click', handleDelete);
        
        // 初始加载
        loadAnnouncements();
    });
</script>
{% endblock %}