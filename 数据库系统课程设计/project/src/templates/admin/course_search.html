{% extends "base.html" %}

{% block title %}课程查询 - 教务管理系统{% endblock %}

{% block head_extra %}
<style>
    .course-search-container {
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
    }
    .page-header {
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #4CAF50;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .filters-section {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    .filter-row {
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
    }
    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
    .filter-group label {
        font-weight: bold;
        font-size: 14px;
    }
    .filter-group select, .filter-group input {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        min-width: 150px;
    }
    .btn-primary {
        background-color: #4CAF50;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
    }
    .btn-primary:hover {
        background-color: #45a049;
    }
    .btn-secondary {
        background-color: #2196f3;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }
    .btn-secondary:hover {
        background-color: #1976d2;
    }
    .btn-danger {
        background-color: #f44336;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }
    .btn-danger:hover {
        background-color: #d32f2f;
    }
    .loading {
        text-align: center;
        padding: 40px;
    }
    .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #4CAF50;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .results-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }
    .results-table th {
        background-color: #f5f5f5;
        padding: 10px;
        text-align: left;
        border-bottom: 2px solid #ddd;
    }
    .results-table td {
        padding: 10px;
        border-bottom: 1px solid #eee;
    }
    .results-table tr:hover {
        background-color: #f9f9f9;
    }
    .empty-state {
        text-align: center;
        padding: 40px;
        color: #666;
    }
    .empty-state i {
        font-size: 48px;
        margin-bottom: 10px;
        color: #ddd;
    }
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
        background-color: white;
        margin: 10% auto;
        padding: 20px;
        border-radius: 8px;
        width: 60%;
        max-width: 600px;
    }
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
    }
    .modal-header h3 {
        margin: 0;
    }
    .close-btn {
        font-size: 24px;
        font-weight: bold;
        cursor: pointer;
    }
    .form-group {
        margin-bottom: 15px;
    }
    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
    }
    .form-group input, .form-group select, .form-group textarea {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    .form-group textarea {
        height: 100px;
    }
    .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
    }
    .badge {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
    }
    .badge-success {
        background-color: #4CAF50;
        color: white;
    }
    .badge-danger {
        background-color: #f44336;
        color: white;
    }
    .course-detail {
        margin-top: 20px;
        padding: 20px;
        background-color: #f8f9fa;
        border-radius: 8px;
        display: none;
    }
    .course-detail-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #ddd;
    }
    .section-list {
        margin-top: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="course-search-container">
    <div class="page-header">
        <h1>课程查询</h1>
        <button class="btn-primary" id="addCourseBtn">添加课程</button>
    </div>
    
    <div class="filters-section">
        <div class="filter-row">
            <div class="filter-group">
                <label for="searchInput">课程ID/名称</label>
                <input type="text" id="searchInput" placeholder="输入课程ID或名称">
            </div>
            <div class="filter-group">
                <label for="deptSelect">所属院系</label>
                <select id="deptSelect">
                    <option value="">全部院系</option>
                    <!-- 院系选项将通过JavaScript动态填充 -->
                </select>
            </div>
            <div class="filter-group">
                <label for="typeSelect">课程类型</label>
                <select id="typeSelect">
                    <option value="">全部类型</option>
                    <!-- 课程类型选项将通过JavaScript动态填充 -->
                </select>
            </div>
            <div class="filter-group" style="align-self: flex-end;">
                <button class="btn-secondary" id="searchBtn">搜索</button>
            </div>
        </div>
    </div>
    
    <div id="loadingIndicator" class="loading" style="display: none;">
        <div class="loading-spinner"></div>
        <p>加载数据中...</p>
    </div>
    
    <table class="results-table" id="coursesTable">
        <thead>
            <tr>
                <th>课程ID</th>
                <th>课程名称</th>
                <th>学分</th>
                <th>类型</th>
                <th>所属院系</th>
                <th>开课班数</th>
                <th>状态</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody id="coursesTableBody">
            <!-- 数据将通过JavaScript动态填充 -->
        </tbody>
    </table>
    
    <div id="emptyState" class="empty-state" style="display: none;">
        <i class="fas fa-search"></i>
        <p>未找到匹配的课程</p>
    </div>
    
    <!-- 课程详情区域 -->
    <div id="courseDetail" class="course-detail">
        <div class="course-detail-header">
            <h3 id="detailCourseTitle">课程详情</h3>
            <button class="btn-secondary" id="closeDetailBtn">关闭</button>
        </div>
        <div class="course-info">
            <p><strong>课程ID:</strong> <span id="detailCourseId"></span></p>
            <p><strong>课程名称:</strong> <span id="detailCourseTitle2"></span></p>
            <p><strong>学分:</strong> <span id="detailCredits"></span></p>
            <p><strong>类型:</strong> <span id="detailType"></span></p>
            <p><strong>所属院系:</strong> <span id="detailDept"></span></p>
            <p><strong>描述:</strong> <span id="detailDescription"></span></p>
            <p><strong>状态:</strong> <span id="detailStatus"></span></p>
        </div>
        <div class="section-list">
            <h4>开课班级</h4>
            <table class="results-table" id="sectionsTable">
                <thead>
                    <tr>
                        <th>班级编号</th>
                        <th>学期</th>
                        <th>容量</th>
                        <th>已选人数</th>
                        <th>主讲教师</th>
                    </tr>
                </thead>
                <tbody id="sectionsTableBody">
                    <!-- 数据将通过JavaScript动态填充 -->
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- 添加/编辑课程模态框 -->
    <div id="courseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">添加课程</h3>
                <span class="close-btn">&times;</span>
            </div>
            <form id="courseForm">
                <input type="hidden" id="editMode" value="add">
                <div class="form-group">
                    <label for="courseId">课程ID</label>
                    <input type="text" id="courseId" required>
                </div>
                <div class="form-group">
                    <label for="courseTitle">课程名称</label>
                    <input type="text" id="courseTitle" required>
                </div>
                <div class="form-group">
                    <label for="credits">学分</label>
                    <input type="number" id="credits" step="0.5" min="0" required>
                </div>
                <div class="form-group">
                    <label for="courseType">课程类型</label>
                    <select id="courseType" required>
                        <option value="必修">必修</option>
                        <option value="选修">选修</option>
                        <option value="通识">通识</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="courseDept">所属院系</label>
                    <select id="courseDept" required>
                        <!-- 院系选项将通过JavaScript动态填充 -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="description">课程描述</label>
                    <textarea id="description"></textarea>
                </div>
                <div class="form-group">
                    <label for="isActive">状态</label>
                    <select id="isActive">
                        <option value="true">激活</option>
                        <option value="false">禁用</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" id="cancelBtn">取消</button>
                    <button type="submit" class="btn-primary" id="saveBtn">保存</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 获取DOM元素
        const loadingIndicator = document.getElementById('loadingIndicator');
        const emptyState = document.getElementById('emptyState');
        const searchInput = document.getElementById('searchInput');
        const deptSelect = document.getElementById('deptSelect');
        const typeSelect = document.getElementById('typeSelect');
        const searchBtn = document.getElementById('searchBtn');
        const coursesTableBody = document.getElementById('coursesTableBody');
        const addCourseBtn = document.getElementById('addCourseBtn');
        const courseModal = document.getElementById('courseModal');
        const closeBtn = document.querySelector('.close-btn');
        const cancelBtn = document.getElementById('cancelBtn');
        const courseForm = document.getElementById('courseForm');
        const modalTitle = document.getElementById('modalTitle');
        const editMode = document.getElementById('editMode');
        const courseId = document.getElementById('courseId');
        const courseDetail = document.getElementById('courseDetail');
        const closeDetailBtn = document.getElementById('closeDetailBtn');
        const courseDept = document.getElementById('courseDept');
        
        // 加载课程列表
        function loadCourses() {
            // 显示加载指示器
            loadingIndicator.style.display = 'block';
            emptyState.style.display = 'none';
            coursesTableBody.innerHTML = '';
            
            // 构建查询参数
            const search = searchInput.value.trim();
            const dept = deptSelect.value;
            const type = typeSelect.value;
            
            let url = '/api/admin/courses';
            const params = [];
            
            if (search) {
                params.push(`search=${encodeURIComponent(search)}`);
            }
            if (dept) {
                params.push(`dept_id=${encodeURIComponent(dept)}`);
            }
            if (type) {
                params.push(`type=${encodeURIComponent(type)}`);
            }
            
            if (params.length > 0) {
                url += '?' + params.join('&');
            }
            
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`网络请求失败: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    loadingIndicator.style.display = 'none';
                    
                    // 填充筛选选项
                    if (data.filters) {
                        // 填充院系选项
                        if (deptSelect.options.length <= 1 && data.filters.departments) {
                            data.filters.departments.forEach(dept => {
                                const option = document.createElement('option');
                                option.value = dept.lyh_dept_id;
                                option.textContent = dept.lyh_dept_name;
                                deptSelect.appendChild(option);
                                
                                // 同时填充模态框中的院系选项
                                const modalOption = document.createElement('option');
                                modalOption.value = dept.lyh_dept_id;
                                modalOption.textContent = dept.lyh_dept_name;
                                courseDept.appendChild(modalOption);
                            });
                        }
                        
                        // 填充课程类型选项
                        if (typeSelect.options.length <= 1 && data.filters.course_types) {
                            data.filters.course_types.forEach(type => {
                                const option = document.createElement('option');
                                option.value = type;
                                option.textContent = type;
                                typeSelect.appendChild(option);
                            });
                        }
                    }
                    
                    // 填充课程列表
                    const courses = data.courses || [];
                    
                    if (courses.length === 0) {
                        emptyState.style.display = 'block';
                        return;
                    }
                    
                    courses.forEach(course => {
                        const row = document.createElement('tr');
                        
                        // 设置状态标签
                        const statusBadge = course.lyh_is_active ? 
                            '<span class="badge badge-success">激活</span>' : 
                            '<span class="badge badge-danger">禁用</span>';
                        
                        row.innerHTML = `
                            <td>${course.lyh_course_id}</td>
                            <td>${course.lyh_course_title}</td>
                            <td>${course.lyh_credits}</td>
                            <td>${course.lyh_type}</td>
                            <td>${course.lyh_dept_name || '-'}</td>
                            <td>${course.section_count}</td>
                            <td>${statusBadge}</td>
                            <td>
                                <a href="/course_detail?id=${course.lyh_course_id}" class="btn-secondary">详情</a>
                                <button class="btn-secondary edit-btn" data-id="${course.lyh_course_id}">编辑</button>
                            </td>
                        `;
                        
                        coursesTableBody.appendChild(row);
                    });
                    
                    // 绑定编辑按钮事件
                    document.querySelectorAll('.edit-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const courseId = this.getAttribute('data-id');
                            editCourse(courseId);
                        });
                    });
                })
                .catch(error => {
                    console.error('获取课程列表失败:', error);
                    loadingIndicator.style.display = 'none';
                    emptyState.style.display = 'block';
                    emptyState.innerHTML = `
                        <i class="fas fa-exclamation-circle"></i>
                        <p>获取课程列表失败: ${error.message}</p>
                        <button class="btn-secondary" onclick="loadCourses()">重试</button>
                    `;
                });
        }
        
        // 查看课程详情
        function viewCourseDetail(courseId) {
            fetch(`/api/admin/course/${courseId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`网络请求失败: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // 填充课程详情
                    document.getElementById('detailCourseId').textContent = data.course.lyh_course_id;
                    document.getElementById('detailCourseTitle').textContent = data.course.lyh_course_title;
                    document.getElementById('detailCourseTitle2').textContent = data.course.lyh_course_title;
                    document.getElementById('detailCredits').textContent = data.course.lyh_credits;
                    document.getElementById('detailType').textContent = data.course.lyh_type;
                    document.getElementById('detailDept').textContent = data.course.lyh_dept_name || '-';
                    document.getElementById('detailDescription').textContent = data.course.lyh_description || '无描述';
                    
                    // 设置状态
                    const statusElement = document.getElementById('detailStatus');
                    if (data.course.lyh_is_active) {
                        statusElement.innerHTML = '<span class="badge badge-success">激活</span>';
                    } else {
                        statusElement.innerHTML = '<span class="badge badge-danger">禁用</span>';
                    }
                    
                    // 填充教学班列表
                    const sectionsTableBody = document.getElementById('sectionsTableBody');
                    sectionsTableBody.innerHTML = '';
                    
                    if (data.sections && data.sections.length > 0) {
                        data.sections.forEach(section => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${section.lyh_section_number}</td>
                                <td>${section.lyh_semester_id}</td>
                                <td>${section.lyh_capacity}</td>
                                <td>${section.lyh_enrolled_count || 0}</td>
                                <td>${section.lyh_instructor_name || '-'}</td>
                            `;
                            sectionsTableBody.appendChild(row);
                        });
                    } else {
                        const row = document.createElement('tr');
                        row.innerHTML = '<td colspan="5" style="text-align: center;">暂无开课记录</td>';
                        sectionsTableBody.appendChild(row);
                    }
                    
                    // 显示详情区域
                    courseDetail.style.display = 'block';
                    
                    // 滚动到详情区域
                    courseDetail.scrollIntoView({ behavior: 'smooth' });
                })
                .catch(error => {
                    console.error('获取课程详情失败:', error);
                    alert(`获取课程详情失败: ${error.message}`);
                });
        }
        
        // 编辑课程
        function editCourse(courseId) {
            // 设置为编辑模式
            editMode.value = 'edit';
            modalTitle.textContent = '编辑课程';
            
            // 禁用课程ID输入框
            document.getElementById('courseId').disabled = true;
            
            // 获取课程详情
            fetch(`/api/admin/course/${courseId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`网络请求失败: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // 填充表单
                    document.getElementById('courseId').value = data.course.lyh_course_id;
                    document.getElementById('courseTitle').value = data.course.lyh_course_title;
                    document.getElementById('credits').value = data.course.lyh_credits;
                    document.getElementById('courseType').value = data.course.lyh_type;
                    document.getElementById('courseDept').value = data.course.lyh_dept_id;
                    document.getElementById('description').value = data.course.lyh_description || '';
                    document.getElementById('isActive').value = data.course.lyh_is_active ? 'true' : 'false';
                    
                    // 显示模态框
                    courseModal.style.display = 'block';
                })
                .catch(error => {
                    console.error('获取课程详情失败:', error);
                    alert(`获取课程详情失败: ${error.message}`);
                });
        }
        
        // 添加课程
        function addCourse() {
            // 设置为添加模式
            editMode.value = 'add';
            modalTitle.textContent = '添加课程';
            
            // 启用课程ID输入框
            document.getElementById('courseId').disabled = false;
            
            // 重置表单
            courseForm.reset();
            
            // 显示模态框
            courseModal.style.display = 'block';
        }
        
        // 保存课程
        function saveCourse(event) {
            event.preventDefault();
            
            // 获取表单数据
            const courseData = {
                course_id: document.getElementById('courseId').value,
                course_title: document.getElementById('courseTitle').value,
                credits: parseFloat(document.getElementById('credits').value),
                type: document.getElementById('courseType').value,
                dept_id: document.getElementById('courseDept').value,
                description: document.getElementById('description').value,
                is_active: document.getElementById('isActive').value === 'true'
            };
            
            // 判断是添加还是编辑
            const isEdit = editMode.value === 'edit';
            const url = isEdit ? `/api/admin/course/${courseData.course_id}` : '/api/admin/course';
            const method = isEdit ? 'PUT' : 'POST';
            
            // 发送请求
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(courseData)
            })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(data => {
                            throw new Error(data.error || `请求失败: ${response.status}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    // 关闭模态框
                    courseModal.style.display = 'none';
                    
                    // 显示成功消息
                    alert(data.message || '操作成功');
                    
                    // 重新加载课程列表
                    loadCourses();
                })
                .catch(error => {
                    console.error('保存课程失败:', error);
                    alert(`保存失败: ${error.message}`);
                });
        }
        
        // 绑定事件
        searchBtn.addEventListener('click', loadCourses);
        addCourseBtn.addEventListener('click', addCourse);
        closeBtn.addEventListener('click', () => courseModal.style.display = 'none');
        cancelBtn.addEventListener('click', () => courseModal.style.display = 'none');
        courseForm.addEventListener('submit', saveCourse);
        closeDetailBtn.addEventListener('click', () => courseDetail.style.display = 'none');
        
        // 回车键触发搜索
        searchInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                loadCourses();
            }
        });
        
        // 点击模态框外部关闭模态框
        window.addEventListener('click', function(event) {
            if (event.target === courseModal) {
                courseModal.style.display = 'none';
            }
        });
        
        // 初始加载
        loadCourses();
    });
</script>
{% endblock %} 