{% extends "base.html" %}

{% block title %}学生管理 - 教务管理系统{% endblock %}

{% block head_extra %}
<style>
    .manage-students-container {
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
    }
    .page-header {
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #4CAF50;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .action-buttons {
        display: flex;
        gap: 10px;
    }
    .btn-primary {
        background-color: #4CAF50;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
    }
    .btn-primary:hover {
        background-color: #45a049;
    }
    .btn-secondary {
        background-color: #2196f3;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }
    .btn-secondary:hover {
        background-color: #1976d2;
    }
    .btn-danger {
        background-color: #f44336;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
    }
    .btn-danger:hover {
        background-color: #d32f2f;
    }
    .filters-section {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    .filter-row {
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
    }
    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
    .filter-group label {
        font-weight: bold;
        font-size: 14px;
    }
    .filter-group select, .filter-group input {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        min-width: 150px;
    }
    .students-table {
        width: 100%;
        border-collapse: collapse;
        background-color: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    .students-table th {
        background-color: #4CAF50;
        color: white;
        padding: 12px;
        text-align: left;
        font-weight: bold;
    }
    .students-table td {
        padding: 12px;
        border-bottom: 1px solid #eee;
    }
    .students-table tr:hover {
        background-color: #f5f5f5;
    }
    .status-badge {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
    }
    .status-active {
        background-color: #4caf50;
        color: white;
    }
    .status-inactive {
        background-color: #ff9800;
        color: white;
    }
    .status-suspended {
        background-color: #f44336;
        color: white;
    }
    .status-graduated {
        background-color: #9c27b0;
        color: white;
    }
    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin-top: 20px;
    }
    .pagination button {
        padding: 8px 12px;
        border: 1px solid #ddd;
        background-color: white;
        cursor: pointer;
        border-radius: 4px;
    }
    .pagination button:hover {
        background-color: #f5f5f5;
    }
    .pagination button.active {
        background-color: #4CAF50;
        color: white;
        border-color: #4CAF50;
    }
    .pagination button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .loading {
        text-align: center;
        padding: 40px;
    }
    .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #4CAF50;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 20px;
        border-radius: 8px;
        width: 80%;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
    }
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
    }
    .close {
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }
    .close:hover {
        color: black;
    }
    .form-group {
        margin-bottom: 15px;
    }
    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
    }
    .form-group input, .form-group select, .form-group textarea {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
    }
    .form-group textarea {
        height: 80px;
        resize: vertical;
    }
    .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
    }
    .stats-summary {
        background-color: #e9f7ef;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
    }
    .stat-item {
        text-align: center;
        padding: 10px;
        background-color: white;
        border-radius: 4px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .stat-value {
        font-size: 20px;
        font-weight: bold;
        color: #2e86de;
    }
    .stat-label {
        font-size: 12px;
        color: #666;
    }
</style>
{% endblock %}

{% block content %}
<div class="manage-students-container">
    <div class="page-header">
        <div>
            <h2>学生管理</h2>
            <p>管理系统中的所有学生信息</p>
        </div>
        <div class="action-buttons">
            <button class="btn-primary" onclick="openAddModal()">添加学生</button>
            <button class="btn-secondary" onclick="exportStudents()">导出数据</button>
            <button class="btn-secondary" onclick="importStudents()">批量导入</button>
        </div>
    </div>
    
    <div class="stats-summary">
        <h3>学生统计</h3>
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-value" id="total-students">--</div>
                <div class="stat-label">学生总数</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="active-students">--</div>
                <div class="stat-label">在读学生</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="graduated-students">--</div>
                <div class="stat-label">已毕业</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="suspended-students">--</div>
                <div class="stat-label">休学/退学</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="avg-gpa">--</div>
                <div class="stat-label">平均GPA</div>
            </div>
        </div>
    </div>
    
    <div class="filters-section">
        <div class="filter-row">
            <div class="filter-group">
                <label for="major-filter">专业</label>
                <select id="major-filter">
                    <option value="">全部专业</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="grade-filter">年级</label>
                <select id="grade-filter">
                    <option value="">全部年级</option>
                    <option value="1">大一</option>
                    <option value="2">大二</option>
                    <option value="3">大三</option>
                    <option value="4">大四</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="status-filter">状态</label>
                <select id="status-filter">
                    <option value="">全部状态</option>
                    <option value="在读">在读</option>
                    <option value="休学">休学</option>
                    <option value="退学">退学</option>
                    <option value="毕业">毕业</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="search-input">搜索</label>
                <input type="text" id="search-input" placeholder="学号、姓名">
            </div>
            <div class="filter-group">
                <label>&nbsp;</label>
                <button id="search-btn" class="btn-secondary">搜索</button>
            </div>
        </div>
    </div>
    
    <div id="loading" class="loading" style="display: none;">
        <div class="loading-spinner"></div>
        <p>正在加载学生数据...</p>
    </div>
    
    <div id="students-table-container">
        <table class="students-table" id="students-table">
            <thead>
                <tr>
                    <th>学号</th>
                    <th>姓名</th>
                    <th>性别</th>
                    <th>专业</th>
                    <th>年级</th>
                    <th>状态</th>
                    <th>GPA</th>
                    <th>总学分</th>
                    <th>联系方式</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="students-tbody">
                <!-- 学生数据将在这里动态加载 -->
            </tbody>
        </table>
        
        <div class="pagination" id="pagination">
            <!-- 分页控件将在这里动态生成 -->
        </div>
    </div>
    
    <!-- 调试信息区域 -->
    <div id="debug-info" style="margin-top: 30px; padding: 15px; background-color: #f8f9fa; border-radius: 8px;">
        <h3>调试信息</h3>
        <pre id="debug-content" style="white-space: pre-wrap; overflow-x: auto;"></pre>
    </div>
</div>

<!-- 学生详情模态框 -->
<div id="student-detail-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">学生详情</h3>
            <span class="close" onclick="closeModal('student-detail-modal')">&times;</span>
        </div>
        <div class="modal-body">
            <!-- 学生详情将在这里动态加载 -->
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeModal('student-detail-modal')">关闭</button>
        </div>
    </div>
</div>

<!-- 编辑学生模态框 -->
<div id="edit-student-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">编辑学生</h3>
            <span class="close" onclick="closeModal('edit-student-modal')">&times;</span>
        </div>
        <form id="edit-student-form">
            <div class="form-group">
                <label for="edit-student-id">学号</label>
                <input type="text" id="edit-student-id" name="student_id" readonly>
            </div>
            <div class="form-group">
                <label for="edit-student-name">姓名 *</label>
                <input type="text" id="edit-student-name" name="student_name" required>
            </div>
            <div class="form-group">
                <label for="edit-gender">性别</label>
                <select id="edit-gender" name="gender">
                    <option value="">请选择</option>
                    <option value="男">男</option>
                    <option value="女">女</option>
                </select>
            </div>
            <div class="form-group">
                <label for="edit-birth-date">出生日期</label>
                <input type="date" id="edit-birth-date" name="birth_date">
            </div>
            <div class="form-group">
                <label for="edit-id-card">身份证号</label>
                <input type="text" id="edit-id-card" name="id_card">
            </div>
            <div class="form-group">
                <label for="edit-phone">联系电话</label>
                <input type="text" id="edit-phone" name="phone">
            </div>
            <div class="form-group">
                <label for="edit-email">邮箱</label>
                <input type="email" id="edit-email" name="email">
            </div>
            <div class="form-group">
                <label for="edit-address">地址</label>
                <textarea id="edit-address" name="address"></textarea>
            </div>
            <div class="form-group">
                <label for="edit-major-id">专业 *</label>
                <select id="edit-major-id" name="major_id" required>
                    <option value="">请选择专业</option>
                </select>
            </div>
            <div class="form-group">
                <label for="edit-admission-year">入学年份</label>
                <input type="number" id="edit-admission-year" name="admission_year" min="2000" max="2030">
            </div>
            <div class="form-group">
                <label for="edit-grade">年级 *</label>
                <select id="edit-grade" name="grade" required>
                    <option value="">请选择年级</option>
                    <option value="1">大一</option>
                    <option value="2">大二</option>
                    <option value="3">大三</option>
                    <option value="4">大四</option>
                </select>
            </div>
            <div class="form-group">
                <label for="edit-duration">学制</label>
                <input type="number" id="edit-duration" name="duration" min="1" max="8" value="4">
            </div>
            <div class="form-group">
                <label for="edit-academic-status">学籍状态</label>
                <select id="edit-academic-status" name="academic_status">
                    <option value="在读">在读</option>
                    <option value="休学">休学</option>
                    <option value="退学">退学</option>
                    <option value="毕业">毕业</option>
                </select>
            </div>
            <div class="form-group">
                <label for="edit-account-status">账号状态</label>
                <select id="edit-account-status" name="account_status">
                    <option value="active">正常</option>
                    <option value="disabled">禁用</option>
                </select>
            </div>
            <div class="form-actions">
                <button type="button" class="btn-secondary" onclick="closeModal('edit-student-modal')">取消</button>
                <button type="button" class="btn-primary" onclick="saveStudent()">保存</button>
            </div>
        </form>
    </div>
</div>

<!-- 添加学生模态框 -->
<div id="add-student-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">添加学生</h3>
            <span class="close" onclick="closeModal('add-student-modal')">&times;</span>
        </div>
        <form id="add-student-form">
            <div class="form-group">
                <label for="add-student-id">学号 *</label>
                <input type="text" id="add-student-id" name="student_id" required placeholder="请输入学号">
            </div>
            <div class="form-group">
                <label for="add-student-name">姓名 *</label>
                <input type="text" id="add-student-name" name="student_name" required placeholder="请输入姓名">
            </div>
            <div class="form-group">
                <label for="add-gender">性别 *</label>
                <select id="add-gender" name="gender" required>
                    <option value="">请选择</option>
                    <option value="男">男</option>
                    <option value="女">女</option>
                </select>
            </div>
            <div class="form-group">
                <label for="add-birth-date">出生日期</label>
                <input type="date" id="add-birth-date" name="birth_date">
            </div>
            <div class="form-group">
                <label for="add-id-card">身份证号</label>
                <input type="text" id="add-id-card" name="id_card" placeholder="请输入身份证号">
            </div>
            <div class="form-group">
                <label for="add-phone">联系电话</label>
                <input type="text" id="add-phone" name="phone" placeholder="请输入联系电话">
            </div>
            <div class="form-group">
                <label for="add-email">邮箱</label>
                <input type="email" id="add-email" name="email" placeholder="请输入邮箱">
            </div>
            <div class="form-group">
                <label for="add-address">地址</label>
                <textarea id="add-address" name="address" placeholder="请输入地址"></textarea>
            </div>
            <div class="form-group">
                <label for="add-major-id">专业 *</label>
                <select id="add-major-id" name="major_id" required>
                    <option value="">请选择专业</option>
                </select>
            </div>
            <div class="form-group">
                <label for="add-admission-year">入学年份</label>
                <input type="number" id="add-admission-year" name="admission_year" min="2000" max="2030" value="2023">
            </div>
            <div class="form-group">
                <label for="add-grade">年级 *</label>
                <select id="add-grade" name="grade" required>
                    <option value="">请选择年级</option>
                    <option value="1">大一</option>
                    <option value="2">大二</option>
                    <option value="3">大三</option>
                    <option value="4">大四</option>
                </select>
            </div>
            <div class="form-group">
                <label for="add-duration">学制</label>
                <input type="number" id="add-duration" name="duration" min="1" max="8" value="4">
            </div>
            <div class="form-group">
                <label for="add-academic-status">学籍状态</label>
                <select id="add-academic-status" name="academic_status">
                    <option value="在读">在读</option>
                    <option value="休学">休学</option>
                    <option value="退学">退学</option>
                    <option value="毕业">毕业</option>
                </select>
            </div>
            <div class="form-actions">
                <button type="button" class="btn-secondary" onclick="closeModal('add-student-modal')">取消</button>
                <button type="button" class="btn-primary" onclick="addStudent()">添加</button>
            </div>
        </form>
    </div>
</div>

<!-- 导入学生模态框 -->
<div id="import-students-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">批量导入学生</h3>
            <span class="close" onclick="closeModal('import-students-modal')">&times;</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>步骤1: 下载CSV模板</label>
                <div>
                    <a href="/student_import_template.csv" download class="btn-secondary">下载CSV模板</a>
                    <p class="help-text">请按照模板格式填写学生信息，必填字段包括：学号、姓名、性别、专业ID、年级</p>
                </div>
            </div>
            <div class="form-group">
                <label>步骤2: 上传填写好的CSV文件</label>
                <div>
                    <input type="file" id="csv-file" accept=".csv">
                    <p class="help-text">请确保CSV文件编码为UTF-8格式</p>
                </div>
            </div>
            <div id="csv-preview" style="display: none;">
                <h4>数据预览</h4>
                <div class="preview-stats">
                    <div>总记录数: <span id="total-records">0</span></div>
                    <div>有效记录: <span id="valid-records">0</span></div>
                    <div>错误记录: <span id="error-records">0</span></div>
                </div>
                <div style="max-height: 300px; overflow-y: auto;">
                    <table class="students-table">
                        <thead>
                            <tr>
                                <th>学号</th>
                                <th>姓名</th>
                                <th>性别</th>
                                <th>专业ID</th>
                                <th>年级</th>
                                <th>状态</th>
                                <th>验证结果</th>
                            </tr>
                        </thead>
                        <tbody id="preview-tbody">
                            <!-- 预览数据将在这里动态加载 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button id="import-csv-btn" class="btn-primary" disabled>导入数据</button>
            <button class="btn-secondary" onclick="closeModal('import-students-modal')">取消</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 页面加载完成后初始化
        console.log("页面加载完成，开始初始化...");
        showDebugInfo("页面加载完成，开始初始化...");
        loadStudents();
    });
    
    // 全局变量
    let currentPage = 1;
    let currentFilters = {
        search: '',
        major_id: '',
        grade: '',
        status: ''
    };
    
    // 加载学生列表
    function loadStudents(page = 1) {
        // 显示加载状态
        document.getElementById('loading').style.display = 'block';
        
        // 检查元素是否存在
        const tableContainer = document.getElementById('students-table-container');
        if (tableContainer) {
            tableContainer.style.display = 'none';
        } else {
            showDebugInfo("错误: 找不到元素 'students-table-container'");
            console.error("找不到元素 'students-table-container'");
        }
        
        // 更新当前页码
        currentPage = page;
        
        // 获取筛选条件
        const search = document.getElementById('search-input').value;
        const majorId = document.getElementById('major-filter').value;
        const grade = document.getElementById('grade-filter').value;
        const status = document.getElementById('status-filter').value;
        
        // 更新当前筛选条件
        currentFilters = {
            search: search,
            major_id: majorId,
            grade: grade,
            status: status
        };
        
        // 构建请求URL
        let url = '/api/admin/students?page=' + page;
        
        if (search) url += '&search=' + encodeURIComponent(search);
        if (majorId) url += '&major_id=' + encodeURIComponent(majorId);
        if (grade) url += '&grade=' + encodeURIComponent(grade);
        if (status) url += '&status=' + encodeURIComponent(status);
        
        showDebugInfo("发送请求: " + url);
        console.log("发送请求: " + url);
        
        // 发送请求
        fetch(url)
            .then(response => {
                console.log("API响应状态:", response.status);
                showDebugInfo("API响应状态: " + response.status);
                
                if (!response.ok) {
                    throw new Error('网络响应不正常，状态码: ' + response.status);
                }
                
                return response.text().then(text => {
                    console.log("原始响应内容:", text.substring(0, 200) + "...");
                    showDebugInfo("原始响应内容: " + text.substring(0, 200) + "...");
                    
                    try {
                        return JSON.parse(text);
                    } catch (e) {
                        console.error("JSON解析错误:", e);
                        showDebugInfo("JSON解析错误: " + e.message + "\n原始内容: " + text.substring(0, 500));
                        throw new Error("无法解析响应数据");
                    }
                });
            })
            .then(data => {
                console.log("解析后的数据:", data);
                showDebugInfo("解析后的数据: " + JSON.stringify(data, null, 2));
                
                if (data.error) {
                    showError(data.error);
                    return;
                }
                
                try {
                    // 更新学生列表
                    displayStudents(data.students);
                    
                    // 更新分页
                    updatePagination(data.pagination);
                    
                    // 更新筛选选项
                    updateFilterOptions(data.filters);
                    
                    // 更新统计信息
                    updateStats(data.stats);
                    
                    // 隐藏加载状态
                    document.getElementById('loading').style.display = 'none';
                    
                    if (tableContainer) {
                        tableContainer.style.display = 'block';
                    }
                } catch (e) {
                    console.error("处理数据时出错:", e);
                    showDebugInfo("处理数据时出错: " + e.message);
                    showError("处理数据时出错: " + e.message);
                }
            })
            .catch(error => {
                console.error('获取学生列表失败:', error);
                showDebugInfo("获取学生列表失败: " + error.message);
                showError('获取学生列表失败: ' + error.message);
                document.getElementById('loading').style.display = 'none';
            });
    }
    
    // 显示调试信息
    function showDebugInfo(message) {
        const debugContent = document.getElementById('debug-content');
        if (debugContent) {
            const timestamp = new Date().toLocaleTimeString();
            debugContent.textContent += `[${timestamp}] ${message}\n\n`;
            // 自动滚动到底部
            debugContent.scrollTop = debugContent.scrollHeight;
        }
    }
    
    // 显示学生列表
    function displayStudents(students) {
        const tbody = document.getElementById('students-tbody');
        if (!tbody) {
            showDebugInfo("错误: 找不到元素 'students-tbody'");
            console.error("找不到元素 'students-tbody'");
            return;
        }
        
        tbody.innerHTML = '';
        
        if (!students || students.length === 0) {
            tbody.innerHTML = '<tr><td colspan="10" class="text-center">没有找到符合条件的学生</td></tr>';
            return;
        }
        
        students.forEach((student, index) => {
            const row = document.createElement('tr');
            
            // 设置学生状态的样式类
            let statusClass = 'status-active';
            if (student.lyh_academic_status === '休学') {
                statusClass = 'status-inactive';
            } else if (student.lyh_academic_status === '退学') {
                statusClass = 'status-suspended';
            } else if (student.lyh_academic_status === '毕业') {
                statusClass = 'status-graduated';
            }
            
            row.innerHTML = `
                <td>${student.lyh_student_id}</td>
                <td>${student.lyh_student_name}</td>
                <td>${student.lyh_gender || '--'}</td>
                <td>${student.lyh_major_name || '--'}</td>
                <td>${student.lyh_grade || '--'}级</td>
                <td><span class="status-badge ${statusClass}">${student.lyh_academic_status || '--'}</span></td>
                <td>${student.lyh_current_gpa !== null ? (typeof student.lyh_current_gpa === 'string' ? student.lyh_current_gpa : Number(student.lyh_current_gpa).toFixed(2)) : '--'}</td>
                <td>${student.lyh_total_credits || '0'}</td>
                <td>${student.lyh_phone || '--'}</td>
                <td>
                    <button class="btn-secondary" onclick="viewStudent('${student.lyh_student_id}')">查看</button>
                    <button class="btn-secondary" onclick="editStudent('${student.lyh_student_id}')">编辑</button>
                    <button class="btn-danger" onclick="deleteStudent('${student.lyh_student_id}', '${student.lyh_student_name}')">删除</button>
                </td>
            `;
            
            tbody.appendChild(row);
        });
    }
    
    // 更新分页
    function updatePagination(pagination) {
        const paginationContainer = document.getElementById('pagination');
        paginationContainer.innerHTML = '';
        
        if (!pagination || pagination.total_pages <= 1) {
            return;
        }
        
        // 添加上一页按钮
        const prevButton = document.createElement('button');
        prevButton.textContent = '上一页';
        prevButton.disabled = pagination.current_page <= 1;
        prevButton.onclick = () => loadStudents(pagination.current_page - 1);
        paginationContainer.appendChild(prevButton);
        
        // 添加页码按钮
        let startPage = Math.max(1, pagination.current_page - 2);
        let endPage = Math.min(pagination.total_pages, pagination.current_page + 2);
        
        // 确保显示至少5个页码按钮（如果有足够的页数）
        if (endPage - startPage + 1 < 5 && pagination.total_pages >= 5) {
            if (startPage === 1) {
                endPage = Math.min(5, pagination.total_pages);
            } else if (endPage === pagination.total_pages) {
                startPage = Math.max(1, pagination.total_pages - 4);
            }
        }
        
        for (let i = startPage; i <= endPage; i++) {
            const pageButton = document.createElement('button');
            pageButton.textContent = i;
            pageButton.className = i === pagination.current_page ? 'active' : '';
            pageButton.onclick = () => loadStudents(i);
            paginationContainer.appendChild(pageButton);
        }
        
        // 添加下一页按钮
        const nextButton = document.createElement('button');
        nextButton.textContent = '下一页';
        nextButton.disabled = pagination.current_page >= pagination.total_pages;
        nextButton.onclick = () => loadStudents(pagination.current_page + 1);
        paginationContainer.appendChild(nextButton);
    }
    
    // 更新筛选选项
    function updateFilterOptions(filters) {
        if (!filters) return;
        
        // 更新专业选项
        const majorFilter = document.getElementById('major-filter');
        if (filters.majors && majorFilter.options.length <= 1) {
            filters.majors.forEach(major => {
                const option = document.createElement('option');
                option.value = major.lyh_major_id;
                option.textContent = major.lyh_major_name;
                majorFilter.appendChild(option);
            });
        }
        
        // 更新年级选项
        const gradeFilter = document.getElementById('grade-filter');
        if (filters.grades && gradeFilter.options.length <= 1) {
            filters.grades.forEach(grade => {
                const option = document.createElement('option');
                option.value = grade;
                option.textContent = grade + '级';
                gradeFilter.appendChild(option);
            });
        }
        
        // 更新状态选项
        const statusFilter = document.getElementById('status-filter');
        if (filters.statuses && statusFilter.options.length <= 1) {
            filters.statuses.forEach(status => {
                const option = document.createElement('option');
                option.value = status;
                option.textContent = status;
                statusFilter.appendChild(option);
            });
        }
    }
    
    // 更新统计信息
    function updateStats(stats) {
        if (!stats) {
            showDebugInfo("错误: 统计数据为空");
            return;
        }
        
        try {
            document.getElementById('total-students').textContent = stats.total_students || 0;
            document.getElementById('active-students').textContent = stats.active_count || 0;
            document.getElementById('graduated-students').textContent = stats.graduated_count || 0;
            document.getElementById('suspended-students').textContent = (stats.suspended_count || 0) + (stats.dropout_count || 0);
            document.getElementById('avg-gpa').textContent = stats.avg_gpa || '0.00';
            
            showDebugInfo("统计信息更新成功");
        } catch (e) {
            console.error("更新统计信息失败:", e);
            showDebugInfo("更新统计信息失败: " + e.message);
        }
    }
    
    // 应用筛选
    function applyFilters() {
        loadStudents(1); // 重置到第一页
    }
    
    // 重置筛选
    function resetFilters() {
        document.getElementById('search-input').value = '';
        document.getElementById('major-filter').value = '';
        document.getElementById('grade-filter').value = '';
        document.getElementById('status-filter').value = '';
        
        loadStudents(1); // 重置到第一页
    }
    
    // 查看学生详情
    function viewStudent(studentId) {
        // 发送请求获取学生详情
        fetch(`/api/admin/student/${studentId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('网络响应不正常，状态码: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    showError(data.error);
                    return;
                }
                
                // 显示学生详情模态框
                showStudentDetailModal(data);
            })
            .catch(error => {
                console.error('获取学生详情失败:', error);
                showError('获取学生详情失败: ' + error.message);
            });
    }
    
    // 显示学生详情模态框
    function showStudentDetailModal(data) {
        const modal = document.getElementById('student-detail-modal');
        const modalTitle = modal.querySelector('.modal-title');
        const modalBody = modal.querySelector('.modal-body');
        
        // 设置模态框标题
        modalTitle.textContent = `学生详情 - ${data.student.lyh_student_name} (${data.student.lyh_student_id})`;
        
        // 构建学生基本信息HTML
        let studentInfoHtml = `
            <div class="student-info">
                <h4>基本信息</h4>
                <table class="detail-table">
                    <tr>
                        <th>学号</th>
                        <td>${data.student.lyh_student_id}</td>
                        <th>姓名</th>
                        <td>${data.student.lyh_student_name}</td>
                    </tr>
                    <tr>
                        <th>性别</th>
                        <td>${data.student.lyh_gender || '--'}</td>
                        <th>出生日期</th>
                        <td>${data.student.lyh_birth_date || '--'}</td>
                    </tr>
                    <tr>
                        <th>身份证号</th>
                        <td>${data.student.lyh_id_card || '--'}</td>
                        <th>手机号</th>
                        <td>${data.student.lyh_phone || '--'}</td>
                    </tr>
                    <tr>
                        <th>邮箱</th>
                        <td>${data.student.lyh_email || '--'}</td>
                        <th>地址</th>
                        <td>${data.student.lyh_address || '--'}</td>
                    </tr>
                    <tr>
                        <th>专业</th>
                        <td>${data.student.lyh_major_name || '--'}</td>
                        <th>院系</th>
                        <td>${data.student.lyh_dept_name || '--'}</td>
                    </tr>
                    <tr>
                        <th>入学年份</th>
                        <td>${data.student.lyh_admission_year || '--'}</td>
                        <th>年级</th>
                        <td>${data.student.lyh_grade ? data.student.lyh_grade + '级' : '--'}</td>
                    </tr>
                    <tr>
                        <th>学制</th>
                        <td>${data.student.lyh_duration || '--'}年</td>
                        <th>学籍状态</th>
                        <td>${data.student.lyh_academic_status || '--'}</td>
                    </tr>
                    <tr>
                        <th>总学分</th>
                        <td>${data.student.lyh_total_credits !== null ? data.student.lyh_total_credits : '--'}</td>
                        <th>GPA</th>
                        <td>${data.student.lyh_current_gpa !== null ? data.student.lyh_current_gpa : '--'}</td>
                    </tr>
                    <tr>
                        <th>账号状态</th>
                        <td>${data.student.account_status || '--'}</td>
                        <th>用户名</th>
                        <td>${data.student.lyh_username || '--'}</td>
                    </tr>
                </table>
            </div>
        `;
        
        // 构建课程记录HTML
        let coursesHtml = '<h4>选课记录</h4>';
        
        if (!data.courses || data.courses.length === 0) {
            coursesHtml += '<p>暂无选课记录</p>';
        } else {
            coursesHtml += `
                <table class="detail-table">
                    <thead>
                        <tr>
                            <th>课程编号</th>
                            <th>课程名称</th>
                            <th>学分</th>
                            <th>学期</th>
                            <th>状态</th>
                            <th>成绩</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            data.courses.forEach(course => {
                coursesHtml += `
                    <tr>
                        <td>${course.lyh_course_id}</td>
                        <td>${course.lyh_course_title}</td>
                        <td>${course.lyh_credits}</td>
                        <td>${course.lyh_semester_id}</td>
                        <td>${course.lyh_status}</td>
                        <td>${course.lyh_letter_grade || (course.lyh_numeric_grade !== null ? course.lyh_numeric_grade : '--')}</td>
                    </tr>
                `;
            });
            
            coursesHtml += '</tbody></table>';
        }
        
        // 设置模态框内容
        modalBody.innerHTML = studentInfoHtml + coursesHtml;
        
        // 显示模态框
        modal.style.display = 'block';
    }
    
    // 关闭模态框
    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'none';
        }
    }
    
    // 编辑学生信息
    function editStudent(studentId) {
        // 发送请求获取学生详情
        fetch(`/api/admin/student/${studentId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('网络响应不正常，状态码: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    showError(data.error);
                    return;
                }
                
                // 显示编辑模态框
                showEditStudentModal(data.student);
            })
            .catch(error => {
                console.error('获取学生详情失败:', error);
                showError('获取学生详情失败: ' + error.message);
            });
    }
    
    // 显示编辑学生模态框
    function showEditStudentModal(student) {
        const modal = document.getElementById('edit-student-modal');
        const modalTitle = modal.querySelector('.modal-title');
        const form = document.getElementById('edit-student-form');
        
        // 设置模态框标题
        modalTitle.textContent = `编辑学生 - ${student.lyh_student_name} (${student.lyh_student_id})`;
        
        // 填充表单字段
        form.elements['student_id'].value = student.lyh_student_id;
        form.elements['student_name'].value = student.lyh_student_name;
        form.elements['gender'].value = student.lyh_gender || '';
        form.elements['birth_date'].value = student.lyh_birth_date || '';
        form.elements['id_card'].value = student.lyh_id_card || '';
        form.elements['phone'].value = student.lyh_phone || '';
        form.elements['email'].value = student.lyh_email || '';
        form.elements['address'].value = student.lyh_address || '';
        form.elements['admission_year'].value = student.lyh_admission_year || '';
        form.elements['grade'].value = student.lyh_grade || '';
        form.elements['duration'].value = student.lyh_duration || '';
        form.elements['academic_status'].value = student.lyh_academic_status || '';
        form.elements['account_status'].value = student.account_status || '';
        
        // 加载专业列表并设置选中项
        loadMajorOptions('edit-major-id', student.lyh_major_id);
        
        // 显示模态框
        modal.style.display = 'block';
    }
    
    // 加载专业列表到下拉框
    function loadMajorOptions(selectId, selectedValue = null) {
        const selectElement = document.getElementById(selectId);
        if (!selectElement) return;
        
        // 保留第一个选项（请选择专业）
        const firstOption = selectElement.options[0];
        selectElement.innerHTML = '';
        selectElement.appendChild(firstOption);
        
        // 从筛选器中获取专业列表
        const majorFilter = document.getElementById('major-filter');
        if (majorFilter && majorFilter.options.length > 1) {
            // 复制专业选项
            for (let i = 1; i < majorFilter.options.length; i++) {
                const option = document.createElement('option');
                option.value = majorFilter.options[i].value;
                option.textContent = majorFilter.options[i].textContent;
                selectElement.appendChild(option);
            }
        } else {
            // 如果筛选器中没有专业，则从API获取
            fetch('/api/admin/majors')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('获取专业列表失败');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.majors && data.majors.length > 0) {
                        data.majors.forEach(major => {
                            const option = document.createElement('option');
                            option.value = major.lyh_major_id;
                            option.textContent = major.lyh_major_name;
                            selectElement.appendChild(option);
                        });
                    }
                    
                    // 设置选中项
                    if (selectedValue) {
                        selectElement.value = selectedValue;
                    }
                })
                .catch(error => {
                    console.error('获取专业列表失败:', error);
                    showDebugInfo('获取专业列表失败: ' + error.message);
                });
        }
        
        // 设置选中项
        if (selectedValue) {
            selectElement.value = selectedValue;
        }
    }
    
    // 保存学生信息
    function saveStudent() {
        const form = document.getElementById('edit-student-form');
        const studentId = form.elements['student_id'].value;
        
        // 表单验证
        const requiredFields = ['student_name', 'major_id', 'grade'];
        for (const field of requiredFields) {
            if (!form.elements[field].value) {
                showError(`请填写${form.elements[field].placeholder || field}`);
                return;
            }
        }
        
        // 构建请求数据
        const data = {
            student_name: form.elements['student_name'].value,
            gender: form.elements['gender'].value || null,
            birth_date: form.elements['birth_date'].value || null,
            id_card: form.elements['id_card'].value || null,
            phone: form.elements['phone'].value || null,
            email: form.elements['email'].value || null,
            address: form.elements['address'].value || null,
            major_id: form.elements['major_id'].value,
            admission_year: form.elements['admission_year'].value || null,
            grade: form.elements['grade'].value,
            duration: form.elements['duration'].value || null,
            academic_status: form.elements['academic_status'].value,
            account_status: form.elements['account_status'].value
        };
        
        // 再次检查专业ID是否为空
        if (!data.major_id) {
            showError('专业不能为空');
            return;
        }
        
        showDebugInfo("提交数据: " + JSON.stringify(data, null, 2));
        
        // 发送更新请求
        fetch(`/api/admin/student/${studentId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('网络响应不正常，状态码: ' + response.status);
            }
            return response.json();
        })
        .then(result => {
            if (result.error) {
                showError(result.error);
                return;
            }
            
            // 关闭模态框
            closeModal('edit-student-modal');
            
            // 显示成功消息
            showSuccess(result.message || '学生信息更新成功');
            
            // 重新加载学生列表
            loadStudents(currentPage);
        })
        .catch(error => {
            console.error('更新学生信息失败:', error);
            showError('更新学生信息失败: ' + error.message);
        });
    }
    
    // 删除学生
    function deleteStudent(studentId, studentName) {
        if (!confirm(`确定要删除学生 ${studentName} (${studentId}) 吗？`)) {
            return;
        }
        
        // 发送删除请求
        fetch(`/api/admin/student/${studentId}`, {
            method: 'DELETE'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('网络响应不正常，状态码: ' + response.status);
            }
            return response.json();
        })
        .then(result => {
            if (result.error) {
                showError(result.error);
                return;
            }
            
            // 显示成功消息
            showSuccess(result.message || '学生删除成功');
            
            // 重新加载学生列表
            loadStudents(currentPage);
        })
        .catch(error => {
            console.error('删除学生失败:', error);
            showError('删除学生失败: ' + error.message);
        });
    }
    
    // 显示添加学生模态框
    function showAddStudentModal() {
        const modal = document.getElementById('add-student-modal');
        const form = document.getElementById('add-student-form');
        
        // 重置表单
        form.reset();
        
        // 加载专业列表
        loadMajorOptions('add-major-id');
        
        // 显示模态框
        modal.style.display = 'block';
    }
    
    // 添加学生
    function addStudent() {
        const form = document.getElementById('add-student-form');
        
        // 验证必填字段
        const requiredFields = ['student_id', 'student_name', 'gender', 'major_id', 'grade'];
        for (const field of requiredFields) {
            if (!form.elements[field].value) {
                showError(`请填写${form.elements[field].placeholder || field}`);
                return;
            }
        }
        
        // 构建请求数据
        const data = {
            student_id: form.elements['student_id'].value,
            student_name: form.elements['student_name'].value,
            gender: form.elements['gender'].value,
            birth_date: form.elements['birth_date'].value || null,
            id_card: form.elements['id_card'].value || null,
            phone: form.elements['phone'].value || null,
            email: form.elements['email'].value || null,
            address: form.elements['address'].value || null,
            major_id: form.elements['major_id'].value,
            admission_year: form.elements['admission_year'].value || null,
            grade: form.elements['grade'].value,
            duration: form.elements['duration'].value || null,
            academic_status: form.elements['academic_status'].value
        };
        
        // 再次检查专业ID是否为空
        if (!data.major_id) {
            showError('专业不能为空');
            return;
        }
        
        showDebugInfo("提交数据: " + JSON.stringify(data, null, 2));
        
        // 发送添加请求
        fetch('/api/admin/student', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('网络响应不正常，状态码: ' + response.status);
            }
            return response.json();
        })
        .then(result => {
            if (result.error) {
                showError(result.error);
                return;
            }
            
            // 关闭模态框
            closeModal('add-student-modal');
            
            // 显示成功消息
            showSuccess(result.message || '学生添加成功');
            
            // 重新加载学生列表
            loadStudents(1);
        })
        .catch(error => {
            console.error('添加学生失败:', error);
            showError('添加学生失败: ' + error.message);
        });
    }
    
    // 显示成功消息
    function showSuccess(message) {
        alert(message); // 简单实现，实际应用中可以使用更美观的提示
        showDebugInfo("成功: " + message);
    }
    
    // 显示错误消息
    function showError(message) {
        alert('错误: ' + message); // 简单实现，实际应用中可以使用更美观的提示
        showDebugInfo("错误: " + message);
    }

    // 绑定事件处理函数
    document.getElementById('search-btn').addEventListener('click', function() {
        applyFilters();
    });

    document.getElementById('search-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            applyFilters();
        }
    });

    // 导出学生数据
    window.exportStudents = function() {
        alert('导出功能正在开发中...');
    };

    // 导入学生
    function importStudents() {
        // 打开导入学生模态框
        const modal = document.getElementById('import-students-modal');
        modal.style.display = 'block';
        
        // 重置文件输入和预览
        document.getElementById('csv-file').value = '';
        document.getElementById('csv-preview').style.display = 'none';
        document.getElementById('import-csv-btn').disabled = true;
    }

    // 监听CSV文件上传
    document.getElementById('csv-file').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        // 检查文件类型
        if (file.type !== 'text/csv' && !file.name.endsWith('.csv')) {
            showError('请上传CSV格式的文件');
            this.value = '';
            return;
        }
        
        // 读取文件内容
        const reader = new FileReader();
        reader.onload = function(event) {
            parseCSV(event.target.result);
        };
        reader.onerror = function() {
            showError('读取文件失败');
        };
        reader.readAsText(file);
    });

    // 解析CSV数据
    function parseCSV(csvText) {
        // 分割行
        const lines = csvText.split(/\r\n|\n/);
        if (lines.length < 2) {
            showError('CSV文件格式不正确或为空');
            return;
        }
        
        // 解析标题行
        const headers = lines[0].split(',').map(h => h.trim());
        
        // 检查必要的字段
        const requiredFields = ['lyh_student_id', 'lyh_student_name', 'lyh_gender', 'lyh_major_id', 'lyh_grade'];
        const missingFields = requiredFields.filter(field => !headers.includes(field));
        
        if (missingFields.length > 0) {
            showError(`CSV文件缺少必要字段: ${missingFields.join(', ')}`);
            return;
        }
        
        // 解析数据行
        const records = [];
        window.validRecords = []; // 存储有效记录
        
        for (let i = 1; i < lines.length; i++) {
            if (!lines[i].trim()) continue; // 跳过空行
            
            const values = lines[i].split(',').map(v => v.trim());
            if (values.length !== headers.length) continue; // 跳过格式不正确的行
            
            // 构建记录对象
            const record = {};
            headers.forEach((header, index) => {
                record[header] = values[index];
            });
            
            // 验证必填字段
            let isValid = true;
            let errorMsg = '';
            
            for (const field of requiredFields) {
                if (!record[field]) {
                    isValid = false;
                    errorMsg = `缺少${field}字段`;
                    break;
                }
            }
            
            // 添加验证结果
            record.isValid = isValid;
            record.error = errorMsg;
            
            // 添加到记录列表
            records.push(record);
            
            // 如果有效，添加到有效记录列表
            if (isValid) {
                window.validRecords.push(record);
            }
        }
        
        // 更新导入统计
        document.getElementById('total-records').textContent = records.length;
        document.getElementById('valid-records').textContent = window.validRecords.length;
        document.getElementById('error-records').textContent = records.length - window.validRecords.length;
        
        // 显示预览
        showCSVPreview(records);
        
        // 启用导入按钮（如果有有效记录）
        document.getElementById('import-csv-btn').disabled = window.validRecords.length === 0;
    }

    // 显示CSV预览
    function showCSVPreview(records) {
        const tbody = document.getElementById('preview-tbody');
        tbody.innerHTML = '';
        
        records.forEach((record, index) => {
            const row = document.createElement('tr');
            
            // 设置行样式
            if (!record.isValid) {
                row.style.backgroundColor = '#ffebee';
            }
            
            // 添加单元格
            row.innerHTML = `
                <td>${record.lyh_student_id || ''}</td>
                <td>${record.lyh_student_name || ''}</td>
                <td>${record.lyh_gender || ''}</td>
                <td>${record.lyh_major_id || ''}</td>
                <td>${record.lyh_grade || ''}</td>
                <td>${record.lyh_academic_status || '在读'}</td>
                <td>${record.isValid ? '<span style="color: green;">有效</span>' : '<span style="color: red;">' + record.error + '</span>'}</td>
            `;
            
            tbody.appendChild(row);
        });
        
        // 显示预览区域
        document.getElementById('csv-preview').style.display = 'block';
    }

    // 导入CSV数据
    document.getElementById('import-csv-btn').addEventListener('click', function() {
        if (!window.validRecords || window.validRecords.length === 0) {
            showError('没有有效的记录可导入');
            return;
        }
        
        // 显示确认对话框
        if (!confirm(`确定要导入 ${window.validRecords.length} 条学生记录吗？`)) {
            return;
        }
        
        // 发送导入请求
        fetch('/api/admin/students/import', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ students: window.validRecords })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('网络响应不正常，状态码: ' + response.status);
            }
            return response.json();
        })
        .then(result => {
            if (result.error) {
                showError(result.error);
                return;
            }
            
            // 关闭模态框
            closeModal('import-students-modal');
            
            // 显示成功消息
            showSuccess(result.message || `成功导入 ${result.imported_count || window.validRecords.length} 条学生记录`);
            
            // 重新加载学生列表
            loadStudents(1);
        })
        .catch(error => {
            console.error('导入学生失败:', error);
            showError('导入学生失败: ' + error.message);
        });
    });

    // 打开添加学生模态框
    window.openAddModal = function() {
        const modal = document.getElementById('add-student-modal');
        const form = document.getElementById('add-student-form');
        
        // 重置表单
        form.reset();
        
        // 加载专业列表
        loadMajorOptions('add-major-id');
        
        // 显示模态框
        modal.style.display = 'block';
    };

    // 关闭模态框
    window.closeModal = function(modalId) {
        if (modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
            }
        } else {
            // 兼容旧版本的调用方式
            const studentModal = document.getElementById('student-modal');
            if (studentModal) {
                studentModal.style.display = 'none';
            }
            
            const detailModal = document.getElementById('student-detail-modal');
            if (detailModal) {
                detailModal.style.display = 'none';
            }
            
            const editModal = document.getElementById('edit-student-modal');
            if (editModal) {
                editModal.style.display = 'none';
            }
            
            const addModal = document.getElementById('add-student-modal');
            if (addModal) {
                addModal.style.display = 'none';
            }
        }
    };

    // 学生表单提交事件
    document.getElementById('student-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const studentData = Object.fromEntries(formData.entries());
        
        const isEdit = document.getElementById('student-id').readOnly;
        const url = isEdit ? `/api/admin/student/${studentData.student_id}` : '/api/admin/student';
        const method = isEdit ? 'PUT' : 'POST';
        
        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(studentData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(isEdit ? '更新成功' : '添加成功');
                closeModal();
                loadStudents(currentPage);
            } else {
                alert((isEdit ? '更新' : '添加') + '失败：' + (data.error || '未知错误'));
            }
        })
        .catch(error => {
            console.error('保存学生信息失败:', error);
            alert('保存失败，请稍后再试');
        });
    });
</script>
{% endblock %} 