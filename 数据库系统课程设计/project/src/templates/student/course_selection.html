{% extends "base.html" %}

{% block title %}课程选择 - 教务管理系统{% endblock %}

{% block head_extra %}
<style>
    .course-selection-container {
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
    }
    .page-header {
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #4CAF50;
    }
    .filters-section {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    .filter-row {
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
    }
    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
    .filter-group label {
        font-weight: bold;
        font-size: 14px;
    }
    .filter-group select, .filter-group input {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        min-width: 150px;
    }
    .courses-table {
        width: 100%;
        border-collapse: collapse;
        background-color: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .courses-table th {
        background-color: #4CAF50;
        color: white;
        padding: 12px;
        text-align: left;
        font-weight: bold;
    }
    .courses-table td {
        padding: 12px;
        border-bottom: 1px solid #eee;
    }
    .courses-table tr:hover {
        background-color: #f5f5f5;
    }
    .course-type-badge {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
    }
    .course-type-required {
        background-color: #ff5722;
        color: white;
    }
    .course-type-elective {
        background-color: #2196f3;
        color: white;
    }
    .course-type-general {
        background-color: #ff9800;
        color: white;
    }
    .enroll-btn {
        background-color: #4CAF50;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
    }
    .enroll-btn:hover {
        background-color: #45a049;
    }
    .enroll-btn:disabled {
        background-color: #ccc;
        cursor: not-allowed;
    }
    .withdraw-btn {
        background-color: #dc3545;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
    }
    .withdraw-btn:hover {
        background-color: #c82333;
    }
    .enrolled-badge {
        background-color: #28a745;
        color: white;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 12px;
    }
    .full-badge {
        background-color: #dc3545;
        color: white;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 12px;
    }
    .loading {
        text-align: center;
        padding: 40px;
    }
    .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #4CAF50;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .no-courses {
        text-align: center;
        padding: 40px;
        color: #666;
    }
    .stats-summary {
        background-color: #e9f7ef;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
    }
    .stat-item {
        text-align: center;
    }
    .stat-value {
        font-size: 24px;
        font-weight: bold;
        color: #2e86de;
    }
    .stat-label {
        font-size: 14px;
        color: #666;
    }
    .section-title {
        margin-top: 30px;
        margin-bottom: 15px;
        font-size: 1.5em;
        color: #333;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
    }
    .tab-container {
        margin-bottom: 20px;
    }
    .tab-buttons {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
    }
    .tab-button {
        padding: 10px 20px;
        background-color: #f8f9fa;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
    }
    .tab-button.active {
        background-color: #4CAF50;
        color: white;
        border-color: #4CAF50;
    }
    .tab-content {
        display: none;
    }
    .tab-content.active {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div class="course-selection-container">
    <div class="page-header">
        <h2>课程选择与管理</h2>
        <p>在这里您可以选择新课程，也可以查看和管理已选课程。</p>
    </div>
    
    <div class="stats-summary">
        <h3>选课概况</h3>
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-value" id="enrolled-count">--</div>
                <div class="stat-label">已选课程数</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="enrolled-credits">--</div>
                <div class="stat-label">已选学分</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="available-courses">--</div>
                <div class="stat-label">可选课程数</div>
            </div>
        </div>
    </div>
    
    <div class="tab-container">
        <div class="tab-buttons">
            <div class="tab-button active" data-tab="available-courses">可选课程</div>
            <div class="tab-button" data-tab="my-courses">我的已选课程</div>
        </div>
        
        <div class="tab-content active" id="available-courses-tab">
            <div class="filters-section">
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="course-type-filter">课程类型</label>
                        <select id="course-type-filter">
                            <option value="">全部</option>
                            <option value="必修">必修</option>
                            <option value="专业选修">专业选修</option>
                            <option value="通识选修">通识选修</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="instructor-filter">任课教师</label>
                        <input type="text" id="instructor-filter" placeholder="教师姓名">
                    </div>
                    <div class="filter-group">
                        <label for="course-name-filter">课程名称</label>
                        <input type="text" id="course-name-filter" placeholder="课程名称">
                    </div>
                    <div class="filter-group">
                        <label for="time-filter">上课时间</label>
                        <select id="time-filter">
                            <option value="">全部时间</option>
                            <option value="周一">周一</option>
                            <option value="周二">周二</option>
                            <option value="周三">周三</option>
                            <option value="周四">周四</option>
                            <option value="周五">周五</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>&nbsp;</label>
                        <button id="refresh-btn" class="enroll-btn">刷新</button>
                    </div>
                </div>
            </div>
            
            <div id="loading" class="loading" style="display: none;">
                <div class="loading-spinner"></div>
                <p>正在加载课程信息...</p>
            </div>
            
            <div id="courses-container">
                <table class="courses-table" id="courses-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>课程代码</th>
                            <th>课程名称</th>
                            <th>学分</th>
                            <th>类型</th>
                            <th>任课教师</th>
                            <th>上课时间</th>
                            <th>上课地点</th>
                            <th>容量</th>
                            <th>已选人数</th>
                            <th>剩余名额</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="courses-tbody">
                        <!-- 课程数据将在这里动态加载 -->
                    </tbody>
                </table>
                
                <div id="no-courses" class="no-courses" style="display: none;">
                    <p>没有找到匹配的课程</p>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="my-courses-tab">
            <div id="my-courses-loading" class="loading" style="display: none;">
                <div class="loading-spinner"></div>
                <p>正在加载已选课程...</p>
            </div>
            
            <div id="my-courses-container">
                <table class="courses-table" id="my-courses-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>课程代码</th>
                            <th>课程名称</th>
                            <th>学分</th>
                            <th>类型</th>
                            <th>任课教师</th>
                            <th>上课时间</th>
                            <th>上课地点</th>
                            <th>成绩</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="my-courses-tbody">
                        <!-- 已选课程数据将在这里动态加载 -->
                    </tbody>
                </table>
                
                <div id="no-my-courses" class="no-courses" style="display: none;">
                    <p>您还没有选择任何课程</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const loadingElement = document.getElementById('loading');
        const coursesTable = document.getElementById('courses-table');
        const coursesBody = document.getElementById('courses-tbody');
        const noCoursesElement = document.getElementById('no-courses');
        const refreshBtn = document.getElementById('refresh-btn');
        
        const myCoursesLoadingElement = document.getElementById('my-courses-loading');
        const myCoursesTable = document.getElementById('my-courses-table');
        const myCoursesBody = document.getElementById('my-courses-tbody');
        const noMyCoursesElement = document.getElementById('no-my-courses');
        
        // 过滤器元素
        const courseTypeFilter = document.getElementById('course-type-filter');
        const instructorFilter = document.getElementById('instructor-filter');
        const courseNameFilter = document.getElementById('course-name-filter');
        const timeFilter = document.getElementById('time-filter');
        
        let allCourses = [];
        let enrolledCourses = [];
        
        // 页面加载时获取数据
        loadCourseData();
        loadEnrolledCourses();
        
        // 设置标签页切换
        setupTabs();
        
        // 刷新按钮点击事件
        refreshBtn.addEventListener('click', function() {
            loadCourseData();
            loadEnrolledCourses();
        });
        
        // 过滤器变化事件
        [courseTypeFilter, instructorFilter, courseNameFilter, timeFilter].forEach(filter => {
            filter.addEventListener('change', filterCourses);
            filter.addEventListener('input', filterCourses);
        });
        
        // 设置标签页切换
        function setupTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const tabId = this.dataset.tab;
                    
                    // 移除所有标签页的活动状态
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // 设置当前标签页为活动状态
                    this.classList.add('active');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                    
                    // 如果切换到我的课程标签，重新加载已选课程
                    if (tabId === 'my-courses') {
                        loadEnrolledCourses();
                    }
                });
            });
        }
        
        // 加载课程数据
        function loadCourseData() {
            showLoading(true);
            
            fetch('/api/available_courses')
                .then(response => response.json())
                .then(data => {
                    allCourses = data;
                    filterCourses();
                    updateStats();
                    showLoading(false);
                })
                .catch(error => {
                    console.error('加载课程数据失败:', error);
                    showError('加载课程数据失败');
                    showLoading(false);
                });
        }
        
        // 加载已选课程
        function loadEnrolledCourses() {
            showMyCoursesLoading(true);
            
            fetch('/api/student/my_courses')
                .then(response => response.json())
                .then(data => {
                    enrolledCourses = data.filter(course => course.lyh_status === '正常');
                    renderMyCourses(enrolledCourses);
                    updateStats();
                    showMyCoursesLoading(false);
                })
                .catch(error => {
                    console.error('加载已选课程失败:', error);
                    showMyCoursesError('加载已选课程失败');
                    showMyCoursesLoading(false);
                });
        }
        
        // 过滤课程
        function filterCourses() {
            const typeFilter = courseTypeFilter.value;
            const instructorName = instructorFilter.value.toLowerCase();
            const courseName = courseNameFilter.value.toLowerCase();
            const timeSlot = timeFilter.value;
            
            const filteredCourses = allCourses.filter(course => {
                const matchType = !typeFilter || course.lyh_type === typeFilter;
                const matchInstructor = !instructorName || 
                    (course.lyh_instructor_name && course.lyh_instructor_name.toLowerCase().includes(instructorName));
                const matchName = !courseName || course.lyh_course_title.toLowerCase().includes(courseName);
                const matchTime = !timeSlot || 
                    (course.lyh_period_desc && course.lyh_period_desc.includes(timeSlot));
                
                return matchType && matchInstructor && matchName && matchTime;
            });
            
            renderCourses(filteredCourses);
        }
        
        // 渲染课程表格
        function renderCourses(courses) {
            if (courses.length === 0) {
                coursesTable.style.display = 'none';
                noCoursesElement.style.display = 'block';
                return;
            }
            
            coursesTable.style.display = 'table';
            noCoursesElement.style.display = 'none';
            
            coursesBody.innerHTML = '';
            
            courses.forEach(course => {
                const row = document.createElement('tr');
                const isEnrolled = enrolledCourses.some(enrolled => enrolled.lyh_section_id === course.lyh_section_id);
                const isFull = course.available_spots <= 0;
                
                row.innerHTML = `
                    <td>${course.lyh_course_id}</td>
                    <td>${course.lyh_course_title}</td>
                    <td>${course.lyh_credits}</td>
                    <td><span class="course-type-badge course-type-${getCourseTypeClass(course.lyh_type)}">${course.lyh_type}</span></td>
                    <td>${course.lyh_instructor_name || '--'}</td>
                    <td>${course.lyh_period_desc || '--'}</td>
                    <td>${course.lyh_building_name || '--'} ${course.lyh_room_number || '--'}</td>
                    <td>${course.lyh_capacity}</td>
                    <td>${course.lyh_enrolled_count}</td>
                    <td>${course.available_spots}</td>
                    <td>${getActionButton(course, isEnrolled, isFull)}</td>
                `;
                
                coursesBody.appendChild(row);
            });
            
            // 为选课按钮添加事件监听器
            document.querySelectorAll('.enroll-btn[data-section-id]').forEach(btn => {
                btn.addEventListener('click', function() {
                    const sectionId = this.dataset.sectionId;
                    enrollInCourse(sectionId);
                });
            });
        }
        
        // 渲染我的课程表格
        function renderMyCourses(courses) {
            if (courses.length === 0) {
                myCoursesTable.style.display = 'none';
                noMyCoursesElement.style.display = 'block';
                return;
            }
            
            myCoursesTable.style.display = 'table';
            noMyCoursesElement.style.display = 'none';
            
            myCoursesBody.innerHTML = '';
            
            courses.forEach(course => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${course.lyh_course_id}</td>
                    <td>${course.lyh_course_title}</td>
                    <td>${course.lyh_credits}</td>
                    <td><span class="course-type-badge course-type-${getCourseTypeClass(course.lyh_type || '专业选修')}">${course.lyh_type || '未知'}</span></td>
                    <td>${course.lyh_instructor_name || '--'}</td>
                    <td>${course.lyh_period_desc || '--'}</td>
                    <td>${course.lyh_building_name || '--'} ${course.lyh_room_number || '--'}</td>
                    <td>${course.lyh_numeric_grade !== null ? course.lyh_numeric_grade : '未评分'}</td>
                    <td><button class="withdraw-btn" data-section-id="${course.lyh_section_id}">退课</button></td>
                `;
                
                myCoursesBody.appendChild(row);
            });
            
            // 为退课按钮添加事件监听器
            document.querySelectorAll('.withdraw-btn[data-section-id]').forEach(btn => {
                btn.addEventListener('click', function() {
                    const sectionId = this.dataset.sectionId;
                    withdrawFromCourse(sectionId);
                });
            });
        }
        
        // 获取课程类型样式类
        function getCourseTypeClass(type) {
            switch(type) {
                case '必修': return 'required';
                case '专业选修': return 'elective';
                case '通识选修': return 'general';
                default: return 'elective';
            }
        }
        
        // 获取操作按钮
        function getActionButton(course, isEnrolled, isFull) {
            if (isEnrolled) {
                return '<span class="enrolled-badge">已选</span>';
            } else if (isFull) {
                return '<span class="full-badge">已满</span>';
            } else {
                return `<button class="enroll-btn" data-section-id="${course.lyh_section_id}">选课</button>`;
            }
        }
        
        // 选课操作
        function enrollInCourse(sectionId) {
            if (!confirm('确定要选择这门课程吗？')) {
                return;
            }
            
            fetch('/api/student/enroll', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    section_id: parseInt(sectionId)
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('选课成功！');
                    loadCourseData();
                    loadEnrolledCourses();
                } else {
                    alert('选课失败：' + (data.error || '未知错误'));
                }
            })
            .catch(error => {
                console.error('选课请求失败:', error);
                alert('选课请求失败，请稍后再试');
            });
        }
        
        // 退课操作
        function withdrawFromCourse(sectionId) {
            if (!confirm('确定要退选这门课程吗？')) {
                return;
            }
            
            fetch('/api/student/withdraw', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    section_id: parseInt(sectionId)
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('退课成功！');
                    loadCourseData();
                    loadEnrolledCourses();
                } else {
                    alert('退课失败：' + (data.error || '未知错误'));
                }
            })
            .catch(error => {
                console.error('退课请求失败:', error);
                alert('退课请求失败，请稍后再试');
            });
        }
        
        // 更新统计信息
        function updateStats() {
            const enrolledCount = enrolledCourses.length;
            const enrolledCredits = enrolledCourses.reduce((sum, course) => sum + (parseFloat(course.lyh_credits) || 0), 0);
            const availableCount = allCourses.length;
            
            document.getElementById('enrolled-count').textContent = enrolledCount;
            document.getElementById('enrolled-credits').textContent = enrolledCredits.toFixed(1);
            document.getElementById('available-courses').textContent = availableCount;
        }
        
        // 显示/隐藏加载指示器
        function showLoading(show) {
            loadingElement.style.display = show ? 'block' : 'none';
        }
        
        // 显示/隐藏我的课程加载指示器
        function showMyCoursesLoading(show) {
            myCoursesLoadingElement.style.display = show ? 'block' : 'none';
        }
        
        // 显示错误信息
        function showError(message) {
            coursesTable.style.display = 'none';
            noCoursesElement.style.display = 'block';
            noCoursesElement.innerHTML = `<p style="color: red;">${message}</p>`;
        }
        
        // 显示我的课程错误信息
        function showMyCoursesError(message) {
            myCoursesTable.style.display = 'none';
            noMyCoursesElement.style.display = 'block';
            noMyCoursesElement.innerHTML = `<p style="color: red;">${message}</p>`;
        }
    });
</script>
{% endblock %} 